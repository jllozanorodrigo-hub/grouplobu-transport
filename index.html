<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Group Lobu ¬∑ Transporte</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#8B7332;--gold-light:#B8963E;--gold-pale:#E8D5A3;--gold-soft:#F5EDD6;
  --cream:#F7F3EC;--cream2:#EDE6D6;--bg:#FAFAF7;--surface:#FFFFFF;--surface2:#F5F0E8;
  --border:#E2D9C8;--border2:#D4C9B0;--text:#2C2416;--text2:#5C5040;--muted:#9B8E7A;
  --green:#4A7C59;--green-bg:#EBF3EE;--blue:#3A6B8A;--blue-bg:#E8F0F5;
  --red:#A03030;--red-bg:#F5EAEA;--warn:#8B6020;--warn-bg:#FBF3E3;
  --purple:#6B4A8B;--purple-bg:#F0EBF5;--radius:14px;--shadow:0 2px 12px rgba(139,115,50,.1);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;max-width:430px;margin:0 auto;overflow-x:hidden;}

/* LOGIN */
.login-screen{position:fixed;inset:0;background:var(--cream);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:32px 24px;max-width:430px;margin:0 auto;}
.login-leaf{width:80px;height:80px;background:var(--gold-soft);border:2px solid var(--gold-pale);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 16px;box-shadow:0 6px 24px rgba(139,115,50,.2);}
.login-title{font-family:'Playfair Display',serif;font-size:30px;color:var(--gold);font-weight:700;text-align:center;}
.login-sub{font-size:14px;color:var(--muted);text-align:center;margin-top:4px;margin-bottom:36px;}
.login-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;}
.login-input{width:100%;padding:14px 16px;margin-bottom:14px;background:var(--surface);border:1.5px solid var(--border2);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text);outline:none;transition:border-color .15s;}
.login-input:focus{border-color:var(--gold);}
.login-btn{width:100%;padding:15px;background:var(--gold);color:#fff;border:none;border-radius:12px;font-family:'Playfair Display',serif;font-size:18px;font-weight:700;cursor:pointer;transition:background .15s;letter-spacing:.5px;}
.login-btn:active{background:var(--gold-light);}
.login-error{background:var(--red-bg);border:1px solid #E5C0C0;color:var(--red);border-radius:10px;padding:10px 14px;font-size:13px;text-align:center;margin-bottom:14px;display:none;}
.login-error.show{display:block;}
.login-hint{margin-top:20px;padding:12px 14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);font-size:12px;color:var(--muted);text-align:center;line-height:1.7;}
.login-hint strong{color:var(--text2);}

/* HEADER */
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 18px 12px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.logo-wrap{display:flex;align-items:center;gap:10px;}
.logo-leaf{width:32px;height:32px;background:var(--gold-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;}
.logo-text{font-family:'Playfair Display',serif;font-size:17px;color:var(--gold);font-weight:700;}
.logo-sub{font-size:10px;color:var(--muted);font-weight:500;letter-spacing:.5px;}
.header-right{display:flex;align-items:center;gap:8px;}
.driver-chip{background:var(--gold-soft);border:1px solid var(--gold-pale);border-radius:20px;padding:5px 12px;font-size:12px;color:var(--gold);font-weight:600;display:flex;align-items:center;gap:6px;}
.logout-btn{background:var(--red-bg);border:1px solid #E5C0C0;border-radius:20px;padding:5px 10px;font-size:12px;color:var(--red);font-weight:600;cursor:pointer;}
.header-date{font-size:13px;color:var(--muted);}
.header-date strong{color:var(--text);font-weight:600;}

/* NAV */
.nav{display:flex;background:var(--surface);border-top:1px solid var(--border);position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;z-index:100;box-shadow:0 -2px 12px rgba(139,115,50,.08);}
.nav-btn{flex:1;padding:10px 4px 14px;background:none;border:none;color:var(--muted);font-size:9px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:color .15s;text-transform:uppercase;letter-spacing:.5px;position:relative;}
.nav-btn svg{width:20px;height:20px;stroke-width:1.8;}
.nav-btn.active{color:var(--gold);}
.nav-btn.active svg{stroke:var(--gold);}
.nav-btn.tab-admin{color:var(--purple);}
.nav-btn.tab-admin svg{stroke:var(--purple);}
.nav-btn.tab-admin.active{color:var(--purple);}
.nav-lock{position:absolute;top:8px;right:calc(50% - 13px);font-size:9px;}

/* CONTENT */
.content{padding:16px 16px 90px;}
.section{display:none;}
.section.active{display:block;}
.sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.sec-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--text);font-weight:700;}
.sec-sub{font-size:12px;color:var(--muted);font-weight:400;font-family:'DM Sans',sans-serif;}
.btn-add{background:var(--gold);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;}
.btn-add:active{background:var(--gold-light);}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;box-shadow:var(--shadow);}
.badge{font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;white-space:nowrap;}
.badge-green{background:var(--green-bg);color:var(--green);}
.badge-gold{background:var(--gold-soft);color:var(--gold);}
.badge-blue{background:var(--blue-bg);color:var(--blue);}
.badge-red{background:var(--red-bg);color:var(--red);}
.badge-warn{background:var(--warn-bg);color:var(--warn);}
.badge-purple{background:var(--purple-bg);color:var(--purple);}
.chevron{transition:transform .3s;color:var(--muted);font-size:16px;}
.chevron.open{transform:rotate(180deg);}

/* RUTAS */
.ruta-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;box-shadow:var(--shadow);}
.ruta-card-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;}
.ruta-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.ruta-icon.manana{background:var(--blue-bg);}
.ruta-icon.tarde{background:var(--warn-bg);}
.ruta-card-info{flex:1;min-width:0;}
.ruta-name{font-weight:700;font-size:15px;}
.ruta-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.ruta-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .3s;}
.ruta-expand.open{max-height:900px;padding:0 16px 16px;}
.parada-row{display:flex;gap:10px;align-items:flex-start;}
.parada-line{display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
.p-dot{width:11px;height:11px;border-radius:50%;border:2px solid var(--gold-pale);background:#fff;margin-top:3px;}
.p-dot.activo{border-color:var(--gold);background:var(--gold);}
.p-dot.destino{border-color:var(--green);background:var(--green);}
.p-connector{width:2px;flex:1;min-height:22px;background:var(--border);margin:2px 0;}
.parada-info{flex:1;padding-bottom:14px;}
.parada-nombre{font-size:13px;font-weight:600;}
.parada-dir{font-size:11px;color:var(--muted);}
.parada-hora{font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);margin-top:1px;}
.btn-marcaje{flex:1;padding:9px;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn-marcaje:active{transform:scale(.97);}
.btn-marcaje:disabled{opacity:.4;cursor:not-allowed;}
.btn-reco{background:var(--blue-bg);color:var(--blue);border:1px solid #C0D5E5;}
.btn-lleg{background:var(--green-bg);color:var(--green);border:1px solid #BCDAC8;}
.btn-reco.done{background:var(--blue);color:#fff;}
.btn-lleg.done{background:var(--green);color:#fff;}
.ts-label{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center;margin-top:4px;}
.ruta-actions{display:flex;gap:8px;margin-top:12px;}
.btn-action{flex:1;padding:9px;border-radius:9px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn-action.danger{border-color:#E5C0C0;color:var(--red);background:var(--red-bg);}
.btn-action.primary{border-color:var(--gold-pale);color:var(--gold);background:var(--gold-soft);}
.obs-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:6px;font-size:11px;font-weight:600;background:var(--warn-bg);color:var(--warn);border:1px solid #E5D0A0;margin-right:4px;margin-bottom:4px;}

/* GRUPOS */
.grupo-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;box-shadow:var(--shadow);}
.grupo-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;}
.grupo-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.grupo-info{flex:1;}
.grupo-name{font-weight:700;font-size:15px;}
.grupo-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.grupo-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .3s;}
.grupo-expand.open{max-height:500px;padding:0 16px 16px;}
.usuario-mini{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.usuario-mini:last-child{border-bottom:none;}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;color:var(--gold);background:var(--gold-soft);border:1px solid var(--gold-pale);}

/* USUARIOS */
.usuario-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;box-shadow:var(--shadow);}
.usuario-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;}
.avatar-lg{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0;border:2px solid var(--gold-pale);}
.u-info{flex:1;min-width:0;}
.u-name{font-weight:700;font-size:15px;}
.u-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.usuario-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .3s;}
.usuario-expand.open{max-height:400px;padding:0 16px 16px;}
.u-detail-row{display:flex;gap:6px;margin-bottom:6px;align-items:flex-start;}
.u-detail-label{font-size:11px;color:var(--muted);min-width:80px;padding-top:1px;text-transform:uppercase;letter-spacing:.5px;}
.u-detail-val{font-size:13px;font-weight:500;flex:1;}

/* STATS / OP */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;box-shadow:var(--shadow);}
.stat-n{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;line-height:1;}
.stat-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:4px;}
.prog-bar{background:var(--cream2);border-radius:4px;height:7px;overflow:hidden;}
.prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--gold),var(--gold-light));transition:width .5s;}

/* REVISION */
.rev-kpi-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.rev-kpi{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);}
.rev-kpi-n{font-family:'DM Mono',monospace;font-size:22px;font-weight:500;line-height:1;}
.rev-kpi-l{font-size:11px;color:var(--muted);margin-top:4px;}
.admin-badge{display:inline-flex;align-items:center;gap:6px;background:var(--purple-bg);border:1px solid #D8C8E8;border-radius:20px;padding:5px 14px;font-size:12px;font-weight:700;color:var(--purple);margin-bottom:14px;}
.filter-pill{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .15s;}
.filter-pill.active{background:var(--gold);color:#fff;border-color:var(--gold);}
.rev-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;box-shadow:var(--shadow);}
.rev-card-head{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;border-left:4px solid var(--border);}
.rev-card-head.completa{border-left-color:var(--green);}
.rev-card-head.parcial{border-left-color:var(--warn);}
.rev-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s;}
.rev-expand.open{max-height:800px;padding:0 16px 16px;}
.rev-event{display:flex;align-items:flex-start;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);}
.rev-event:last-child{border-bottom:none;}
.rev-time{font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);min-width:44px;padding-top:2px;}
.rev-dot{width:10px;height:10px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.rev-dot.ok{background:var(--green);}
.rev-dot.pending{background:var(--border2);}
.rev-ev-title{font-size:13px;font-weight:600;}
.rev-ev-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.rev-duracion{display:inline-flex;align-items:center;gap:4px;background:var(--purple-bg);color:var(--purple);border:1px solid #D8C8E8;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:600;}
.access-denied{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;text-align:center;}

/* VEH√çCULO */
.veh-tabs{display:flex;gap:6px;margin-bottom:14px;background:var(--surface2);border-radius:12px;padding:4px;}
.veh-tab{flex:1;padding:8px 6px;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);background:none;transition:all .2s;text-align:center;}
.veh-tab.active{background:var(--surface);color:var(--text);box-shadow:0 1px 6px rgba(139,115,50,.12);}
.veh-panel{display:none;}
.veh-panel.active{display:block;}
.veh-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;overflow:hidden;box-shadow:var(--shadow);}
.veh-item-head{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;}
.veh-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.veh-icon.gasoil{background:#FFF3CD;} .veh-icon.incidencia{background:var(--red-bg);} .veh-icon.mantenimiento{background:var(--green-bg);}
.veh-item-info{flex:1;min-width:0;}
.veh-item-title{font-weight:700;font-size:14px;}
.veh-item-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.veh-item-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .3s;}
.veh-item-expand.open{max-height:400px;padding:0 16px 14px;}
.veh-detail-row{display:flex;gap:6px;margin-bottom:6px;align-items:flex-start;}
.veh-detail-label{font-size:11px;color:var(--muted);min-width:90px;padding-top:1px;text-transform:uppercase;letter-spacing:.5px;}
.veh-detail-val{font-size:13px;font-weight:500;flex:1;}
.veh-kpi-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}
.veh-kpi{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;box-shadow:var(--shadow);}
.veh-kpi-n{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;line-height:1;}
.veh-kpi-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
.sev-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;}
.sev-alta{background:var(--red-bg);color:var(--red);}
.sev-media{background:var(--warn-bg);color:var(--warn);}
.sev-baja{background:var(--green-bg);color:var(--green);}
.estado-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;}
.estado-pendiente{background:var(--warn-bg);color:var(--warn);}
.estado-en-curso{background:var(--blue-bg);color:var(--blue);}
.estado-resuelto{background:var(--green-bg);color:var(--green);}
.estado-programado{background:var(--purple-bg);color:var(--purple);}
.estado-completado{background:var(--green-bg);color:var(--green);}

/* ADMIN PANEL TABS */
.admin-panel-tabs{display:flex;gap:0;margin-bottom:16px;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.admin-panel-tab{flex:1;padding:10px 6px;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;text-align:center;border-right:1px solid var(--border);}
.admin-panel-tab:last-child{border-right:none;}
.admin-panel-tab.active{background:var(--purple);color:#fff;}
.admin-panel-section{display:none;}
.admin-panel-section.active{display:block;}

/* USER MANAGEMENT */
.sys-user-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;overflow:hidden;box-shadow:var(--shadow);}
.sys-user-head{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;}
.sys-user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0;}
.sys-user-info{flex:1;}
.sys-user-name{font-weight:700;font-size:15px;}
.sys-user-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.sys-user-expand{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .3s;}
.sys-user-expand.open{max-height:300px;padding:0 16px 14px;}
.role-badge-admin{background:var(--purple-bg);color:var(--purple);border:1px solid #D8C8E8;font-size:11px;font-weight:700;padding:3px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;}
.role-badge-chofer{background:var(--blue-bg);color:var(--blue);border:1px solid #C0D5E5;font-size:11px;font-weight:700;padding:3px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;}
.pass-field{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'DM Mono',monospace;font-size:13px;color:var(--text2);display:flex;align-items:center;justify-content:space-between;}
.pass-toggle{background:none;border:none;font-size:12px;color:var(--muted);cursor:pointer;padding:2px 6px;}
.danger-zone{background:var(--red-bg);border:1px solid #E5C0C0;border-radius:10px;padding:12px;margin-top:10px;}
.danger-zone-title{font-size:11px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}

/* INFORMES */
.inf-section-title{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;color:var(--text);margin:16px 0 10px;}
.inf-filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.inf-filter-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;min-width:50px;}
.inf-date-input{flex:1;padding:8px 12px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);outline:none;min-width:0;}
.inf-date-input:focus{border-color:var(--gold);}
.inf-table{width:100%;border-collapse:collapse;font-size:13px;margin-bottom:4px;}
.inf-table th{background:var(--surface2);color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:8px 10px;text-align:left;border-bottom:2px solid var(--border);}
.inf-table td{padding:9px 10px;border-bottom:1px solid var(--border);vertical-align:top;}
.inf-table tr:last-child td{border-bottom:none;}
.inf-table tr:hover td{background:var(--cream);}
.inf-total-row td{font-weight:700;color:var(--gold);background:var(--gold-soft)!important;border-top:2px solid var(--gold-pale);}
.inf-export-btn{width:100%;padding:11px;background:var(--green);color:#fff;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px;}
.inf-export-btn:active{opacity:.85;}
.inf-tabs{display:flex;gap:0;margin-bottom:14px;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.inf-tab{flex:1;padding:9px 4px;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;text-align:center;border-right:1px solid var(--border);}
.inf-tab:last-child{border-right:none;}
.inf-tab.active{background:var(--gold);color:#fff;}
.chart-bar-wrap{margin-bottom:4px;}
.chart-bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px;}
.chart-bar-track{background:var(--cream2);border-radius:4px;height:10px;overflow:hidden;}
.chart-bar-fill{height:100%;border-radius:4px;transition:width .6s;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(44,36,22,.5);display:flex;align-items:flex-end;z-index:300;opacity:0;pointer-events:none;transition:opacity .25s;max-width:430px;margin:0 auto;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border-radius:20px 20px 0 0;padding:20px 18px 40px;width:100%;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:85dvh;overflow-y:auto;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 18px;}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold);margin-bottom:18px;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;}
.form-input{width:100%;padding:11px 14px;background:var(--cream);border:1px solid var(--border2);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;}
.form-input:focus{border-color:var(--gold);}
.form-input::placeholder{color:var(--muted);}
.form-select{width:100%;padding:11px 14px;background:var(--cream);border:1px solid var(--border2);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;}
.form-row{display:flex;gap:10px;}
.form-row .form-group{flex:1;}
.btn-submit{width:100%;padding:13px;background:var(--gold);color:#fff;border:none;border-radius:12px;font-family:'Playfair Display',serif;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;transition:background .15s;letter-spacing:.5px;}
.btn-submit:active{background:var(--gold-light);}
.btn-cancel{width:100%;padding:11px;background:none;color:var(--muted);border:1px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;margin-top:8px;}
.search-wrap{position:relative;margin-bottom:14px;}
.search-input{width:100%;padding:10px 14px 10px 38px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none;}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:15px;}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(14px);background:var(--text);color:var(--gold-pale);padding:10px 20px;border-radius:30px;font-size:13px;font-weight:600;opacity:0;transition:all .3s;pointer-events:none;z-index:400;white-space:nowrap;border:1px solid var(--gold);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-icon{font-size:48px;margin-bottom:10px;}
::-webkit-scrollbar{width:0;}

/* FIREBASE SYNC STATUS */
.sync-indicator{position:fixed;top:10px;right:10px;z-index:999;font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;pointer-events:none;transition:all .3s;}
.sync-ok{background:#EBF3EE;color:#4A7C59;border:1px solid #BCDAC8;}
.sync-pending{background:#FBF3E3;color:#8B6020;border:1px solid #E5D0A0;}
.sync-error{background:#F5EAEA;color:#A03030;border:1px solid #E5C0C0;}
</style>

<!-- Firebase SDK -->
<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACI√ìN FIREBASE ‚Äî Edita estos valores con
// los de tu proyecto en Firebase Console
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey:            "TU_API_KEY",
  authDomain:        "TU_PROJECT.firebaseapp.com",
  databaseURL:       "https://TU_PROJECT-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "TU_PROJECT",
  storageBucket:     "TU_PROJECT.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId:             "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ‚îÄ‚îÄ‚îÄ Indicador de sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncStatus(state, msg) {
  let el = document.getElementById('sync-indicator');
  if (!el) {
    el = document.createElement('div');
    el.id = 'sync-indicator';
    el.className = 'sync-indicator';
    document.body.appendChild(el);
  }
  el.className = 'sync-indicator sync-' + state;
  el.textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ Escucha en tiempo real toda la DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRealtimeSync() {
  const dbRef = ref(db, 'grouplobu');
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      if (data.rutas)         window.DB.rutas         = Object.values(data.rutas);
      if (data.grupos)        window.DB.grupos        = Object.values(data.grupos);
      if (data.usuarios)      window.DB.usuarios      = Object.values(data.usuarios);
      if (data.historial)     window.DB.historial     = Object.values(data.historial);
      if (data.repostajes)    window.DB.repostajes    = Object.values(data.repostajes);
      if (data.incidencias)   window.DB.incidencias   = Object.values(data.incidencias);
      if (data.mantenimientos) window.DB.mantenimientos = Object.values(data.mantenimientos);
      if (data.nextId)        window.DB.nextId        = data.nextId;
      if (data.sysUsers)      window.SYS_USERS        = Object.values(data.sysUsers);
      if (data.nextSysId)     window.nextSysId        = data.nextSysId;
      // Re-render si la app est√° visible
      if (document.getElementById('app').style.display === 'block') {
        if (typeof window.renderAll === 'function') window.renderAll();
      }
      setSyncStatus('ok', '‚òÅ Sincronizado');
    }
  }, (err) => {
    setSyncStatus('error', '‚ö† Sin conexi√≥n');
    console.warn('Firebase error:', err);
  });
}

// ‚îÄ‚îÄ‚îÄ Escritura completa de la DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pushDB() {
  setSyncStatus('pending', '‚Üë Guardando...');
  try {
    // Convertir arrays a objetos indexados por id para Firebase
    const toObj = (arr) => arr.reduce((o, item) => { o[item.id] = item; return o; }, {});
    const payload = {
      rutas:          toObj(window.DB.rutas),
      grupos:         toObj(window.DB.grupos),
      usuarios:       toObj(window.DB.usuarios),
      historial:      window.DB.historial.reduce((o, h, i) => { o['h'+i] = h; return o; }, {}),
      repostajes:     toObj(window.DB.repostajes),
      incidencias:    toObj(window.DB.incidencias),
      mantenimientos: toObj(window.DB.mantenimientos),
      nextId:         window.DB.nextId,
      sysUsers:       toObj(window.SYS_USERS),
      nextSysId:      window.nextSysId,
    };
    await set(ref(db, 'grouplobu'), payload);
    setSyncStatus('ok', '‚òÅ Guardado');
  } catch(e) {
    setSyncStatus('error', '‚úó Error al guardar');
    console.error('Firebase write error:', e);
  }
}

// ‚îÄ‚îÄ‚îÄ Carga inicial + arrancar escucha ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initFirebase() {
  setSyncStatus('pending', '‚Üì Cargando...');
  try {
    const snapshot = await get(ref(db, 'grouplobu'));
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.rutas)          window.DB.rutas         = Object.values(data.rutas);
      if (data.grupos)         window.DB.grupos        = Object.values(data.grupos);
      if (data.usuarios)       window.DB.usuarios      = Object.values(data.usuarios);
      if (data.historial)      window.DB.historial     = Object.values(data.historial);
      if (data.repostajes)     window.DB.repostajes    = Object.values(data.repostajes);
      if (data.incidencias)    window.DB.incidencias   = Object.values(data.incidencias);
      if (data.mantenimientos) window.DB.mantenimientos= Object.values(data.mantenimientos);
      if (data.nextId)         window.DB.nextId        = data.nextId;
      if (data.sysUsers)       window.SYS_USERS        = Object.values(data.sysUsers);
      if (data.nextSysId)      window.nextSysId        = data.nextSysId;
    } else {
      // Primera vez: subir datos iniciales del c√≥digo
      await pushDB();
    }
    startRealtimeSync();
  } catch(e) {
    setSyncStatus('error', '‚ö† Firebase no configurado');
    console.warn('Firebase init:', e);
    // Continuar en modo offline con datos locales
  }
}

// ‚îÄ‚îÄ‚îÄ Exponer pushDB globalmente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.firebasePushDB = pushDB;

// ‚îÄ‚îÄ‚îÄ Arrancar Firebase cuando el DOM est√© listo ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  // Peque√±o delay para que el script principal inicialice DB y SYS_USERS primero
  setTimeout(initFirebase, 300);
});
</script>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-screen">
  <div class="login-leaf">üåø</div>
  <div class="login-title">Group Lobu</div>
  <div class="login-sub">Sistema de Transporte ¬∑ Atenci√≥</div>
  <div style="width:100%">
    <div id="login-error" class="login-error">‚ö†Ô∏è Usuario o contrase√±a incorrectos</div>
    <label class="login-label">Usuario</label>
    <input class="login-input" id="login-user" type="text" placeholder="Introduce tu usuario" autocomplete="username">
    <label class="login-label">Contrase√±a</label>
    <input class="login-input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Entrar ‚Üí</button>
  </div>
  <div class="login-hint">
    <strong>Usuarios demo:</strong><br>
    admin / lobu2024 &nbsp;¬∑&nbsp; miquel / chofer1<br>
    jordi / chofer2 &nbsp;¬∑&nbsp; anna / chofer3
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<div class="header">
  <div class="header-top">
    <div class="logo-wrap">
      <div class="logo-leaf">üåø</div>
      <div><div class="logo-text">Group Lobu</div><div class="logo-sub">Transport ¬∑ Atenci√≥</div></div>
    </div>
    <div class="header-right">
      <div class="driver-chip" id="header-user">üë§ ‚Äî</div>
      <button class="logout-btn" onclick="doLogout()">‚Ü© Salir</button>
    </div>
  </div>
  <div class="header-date" id="headerDate"></div>
</div>

<div class="content">
  <div class="section active" id="sec-rutas">
    <div class="sec-head"><div><div class="sec-title">Rutas</div><div class="sec-sub" id="rutas-count"></div></div><button class="btn-add" onclick="openModalNew('modal-ruta')">+ Nueva</button></div>
    <div id="rutas-lista"></div>
  </div>
  <div class="section" id="sec-grupos">
    <div class="sec-head"><div><div class="sec-title">Grupos</div><div class="sec-sub" id="grupos-count"></div></div><button class="btn-add" onclick="openModalNew('modal-grupo')">+ Nuevo</button></div>
    <div id="grupos-lista"></div>
  </div>
  <div class="section" id="sec-usuarios">
    <div class="sec-head"><div><div class="sec-title">Usuarios</div><div class="sec-sub" id="usuarios-count"></div></div><button class="btn-add" onclick="openModalNew('modal-usuario')">+ Nuevo</button></div>
    <div class="search-wrap"><span class="search-icon">üîç</span><input class="search-input" type="text" placeholder="Buscar usuario..." oninput="filterUsuarios(this.value)"></div>
    <div id="usuarios-lista"></div>
  </div>
  <div class="section" id="sec-op">
    <div class="sec-head"><div><div class="sec-title">Operativo</div><div class="sec-sub">Seguimiento del turno</div></div></div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-n" style="color:var(--blue)" id="op-total">0</div><div class="stat-l">Servicios</div></div>
      <div class="stat-box"><div class="stat-n" style="color:var(--green)" id="op-done">0</div><div class="stat-l">Complet.</div></div>
      <div class="stat-box"><div class="stat-n" style="color:var(--gold)" id="op-pax">0</div><div class="stat-l">Usuarios</div></div>
    </div>
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;font-size:14px">Progreso del turno</span><span id="op-pct" style="font-family:'DM Mono',monospace;font-size:13px;color:var(--gold)">0%</span></div>
      <div class="prog-bar"><div class="prog-fill" id="op-bar" style="width:0%"></div></div>
    </div>
    <div id="op-rutas-lista"></div>
  </div>
  <div class="section" id="sec-revision"><div id="revision-content"></div></div>
  <div class="section" id="sec-vehiculo"><div id="vehiculo-content"></div></div>
  <div class="section" id="sec-informes"><div id="informes-content"></div></div>
  <div class="section" id="sec-admin"><div id="admin-content"></div></div>
</div>
</div>

<!-- NAV -->
<nav class="nav" id="main-nav" style="display:none">
  <button class="nav-btn active" id="nav-rutas" onclick="switchTab('rutas',this)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
    Rutas
  </button>
  <button class="nav-btn" id="nav-grupos" onclick="switchTab('grupos',this)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    Grupos
  </button>
  <button class="nav-btn" id="nav-usuarios" onclick="switchTab('usuarios',this)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
    Usuarios
  </button>
  <button class="nav-btn" id="nav-op" onclick="switchTab('op',this)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Operativo
  </button>
  <button class="nav-btn tab-admin" id="nav-revision" onclick="switchTab('revision',this)">
    <span class="nav-lock">üîí</span>
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    Revisi√≥n
  </button>
  <button class="nav-btn" id="nav-vehiculo" onclick="switchTab('vehiculo',this)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20A10 10 0 0012 2z" stroke="none" fill="none"/><path d="M9 17H7a2 2 0 01-2-2v-1l1.5-4.5A2 2 0 018.4 8h7.2a2 2 0 011.9 1.5L19 14v1a2 2 0 01-2 2h-2m-4 0h4m-4 0a1 1 0 102 0m2 0a1 1 0 102 0M5 14h14"/></svg>
    Veh√≠culo
  </button>
  <button class="nav-btn tab-admin" id="nav-informes" onclick="switchTab('informes',this)">
    <span class="nav-lock">üîí</span>
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18v12a2 2 0 01-2 2H5a2 2 0 01-2-2V4z"/></svg>
    Informes
  </button>
  <button class="nav-btn tab-admin" id="nav-admin" onclick="switchTab('admin',this)">
    <span class="nav-lock">üîí</span>
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
    Admin
  </button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="modal-ruta" onclick="closeBg(event,'modal-ruta')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-ruta-title">Nueva Ruta</div>
    <input type="hidden" id="ruta-edit-id">
    <div class="form-group"><label class="form-label">Nombre de la ruta *</label><input class="form-input" id="ruta-nombre" placeholder="Ej: Ruta Ma√±ana Calonge"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Turno</label><select class="form-select" id="ruta-turno"><option value="Ma√±ana">Ma√±ana</option><option value="Tarde">Tarde</option><option value="Especial">Especial</option></select></div>
      <div class="form-group"><label class="form-label">Hora inicio</label><input class="form-input" type="time" id="ruta-hora-inicio" value="07:30"></div>
    </div>
    <div class="form-group"><label class="form-label">Centro destino</label><select class="form-select" id="ruta-centro"><option value="Mar i Sol">Mar i Sol</option><option value="Can Clement">Can Clement (CD)</option><option value="Calella CD">Calella CD</option><option value="Mixto">Mixto</option></select></div>
    <div class="form-group"><label class="form-label">Grupo asignado</label><select class="form-select" id="ruta-grupo-sel"><option value="">-- Sin grupo --</option></select></div>
    <div class="form-group"><label class="form-label">Veh√≠culo</label><input class="form-input" id="ruta-vehiculo" placeholder="Matr√≠cula ¬∑ Modelo"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Km estimados</label><input class="form-input" type="number" id="ruta-km" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Tiempo estimado</label><input class="form-input" id="ruta-tiempo" placeholder="ej: 45 min"></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><input class="form-input" id="ruta-obs" placeholder="Notas opcionales"></div>
    <button class="btn-submit" onclick="guardarRuta()">Guardar Ruta</button>
    <button class="btn-cancel" onclick="closeModal('modal-ruta')">Cancelar</button>
  </div>
</div>

<div class="modal-overlay" id="modal-grupo" onclick="closeBg(event,'modal-grupo')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-grupo-title">Nuevo Grupo</div>
    <input type="hidden" id="grupo-edit-id">
    <div class="form-group"><label class="form-label">Nombre del grupo *</label><input class="form-input" id="grupo-nombre" placeholder="Ej: Grupo Calonge"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Centro</label><select class="form-select" id="grupo-centro"><option value="Mar i Sol">Mar i Sol</option><option value="Can Clement">Can Clement</option><option value="Calella CD">Calella CD</option><option value="Mixto">Mixto</option></select></div>
      <div class="form-group"><label class="form-label">Color</label><select class="form-select" id="grupo-color"><option value="#8B7332">Dorado</option><option value="#3A6B8A">Azul</option><option value="#4A7C59">Verde</option><option value="#8B4040">Rojo</option><option value="#6B4A8B">Violeta</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><input class="form-input" id="grupo-obs" placeholder="Notas del grupo"></div>
    <button class="btn-submit" onclick="guardarGrupo()">Guardar Grupo</button>
    <button class="btn-cancel" onclick="closeModal('modal-grupo')">Cancelar</button>
  </div>
</div>

<div class="modal-overlay" id="modal-usuario" onclick="closeBg(event,'modal-usuario')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-usuario-title">Nuevo Usuario</div>
    <input type="hidden" id="usuario-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="u-nombre" placeholder="Nombre"></div>
      <div class="form-group"><label class="form-label">Apellidos *</label><input class="form-input" id="u-apellidos" placeholder="Apellidos"></div>
    </div>
    <div class="form-group"><label class="form-label">Direcci√≥n de recogida *</label><input class="form-input" id="u-dir" placeholder="C/ Ejemplo, 12 ¬∑ Poblaci√≥n"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Hora recogida</label><input class="form-input" type="time" id="u-hora" value="08:00"></div>
      <div class="form-group"><label class="form-label">Grupo</label><select class="form-select" id="u-grupo"><option value="">-- Sin grupo --</option></select></div>
    </div>
    <div class="form-group">
      <label class="form-label">Necesidades especiales</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="obs-silla"> Silla de ruedas</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="obs-andador"> Andador</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="obs-oxigeno"> Ox√≠geno</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="obs-ayuda"> Ayuda embarque</label>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Tel√©fono familiar</label><input class="form-input" id="u-tel" placeholder="600 000 000"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><input class="form-input" id="u-obs" placeholder="Notas adicionales"></div>
    <button class="btn-submit" onclick="guardarUsuario()">Guardar Usuario</button>
    <button class="btn-cancel" onclick="closeModal('modal-usuario')">Cancelar</button>
  </div>
</div>

<!-- MODAL REPOSTAJE -->
<div class="modal-overlay" id="modal-repostaje" onclick="closeBg(event,'modal-repostaje')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-repostaje-title">‚õΩ Nuevo Repostaje</div>
    <input type="hidden" id="rep-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" type="date" id="rep-fecha"></div>
      <div class="form-group"><label class="form-label">Veh√≠culo</label><select class="form-select" id="rep-vehiculo"><option value="">-- Selecciona --</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Km actuales *</label><input class="form-input" type="number" id="rep-km" placeholder="85000"></div>
      <div class="form-group"><label class="form-label">Litros *</label><input class="form-input" type="number" step="0.01" id="rep-litros" placeholder="45.00"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">‚Ç¨/Litro *</label><input class="form-input" type="number" step="0.001" id="rep-precio" placeholder="1.659" oninput="calcImporte()"></div>
      <div class="form-group"><label class="form-label">Importe total</label><input class="form-input" type="number" step="0.01" id="rep-importe" placeholder="Auto" oninput="calcPrecio()"></div>
    </div>
    <div class="form-group"><label class="form-label">Gasolinera</label><input class="form-input" id="rep-gasolinera" placeholder="Ej: Repsol Palam√≥s"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><input class="form-input" id="rep-obs" placeholder="Notas opcionales"></div>
    <button class="btn-submit" onclick="guardarRepostaje()">Guardar Repostaje</button>
    <button class="btn-cancel" onclick="closeModal('modal-repostaje')">Cancelar</button>
  </div>
</div>

<!-- MODAL INCIDENCIA -->
<div class="modal-overlay" id="modal-incidencia" onclick="closeBg(event,'modal-incidencia')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-incidencia-title">‚ö†Ô∏è Nueva Incidencia</div>
    <input type="hidden" id="inc-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" type="date" id="inc-fecha"></div>
      <div class="form-group"><label class="form-label">Veh√≠culo</label><select class="form-select" id="inc-vehiculo"><option value="">-- Selecciona --</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Descripci√≥n *</label><input class="form-input" id="inc-desc" placeholder="Ej: Ruido extra√±o en motor"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Gravedad</label><select class="form-select" id="inc-gravedad"><option value="Baja">üü¢ Baja</option><option value="Media">üü° Media</option><option value="Alta">üî¥ Alta</option></select></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-select" id="inc-estado"><option value="Pendiente">Pendiente</option><option value="En curso">En curso</option><option value="Resuelto">Resuelto</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Km actuales</label><input class="form-input" type="number" id="inc-km" placeholder="85000"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><input class="form-input" id="inc-obs" placeholder="Detalles adicionales"></div>
    <button class="btn-submit" onclick="guardarIncidencia()">Guardar Incidencia</button>
    <button class="btn-cancel" onclick="closeModal('modal-incidencia')">Cancelar</button>
  </div>
</div>

<!-- MODAL MANTENIMIENTO -->
<div class="modal-overlay" id="modal-mantenimiento" onclick="closeBg(event,'modal-mantenimiento')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-mant-title">üîß Nuevo Mantenimiento</div>
    <input type="hidden" id="mant-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" type="date" id="mant-fecha"></div>
      <div class="form-group"><label class="form-label">Veh√≠culo</label><select class="form-select" id="mant-vehiculo"><option value="">-- Selecciona --</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Tipo de mantenimiento *</label><select class="form-select" id="mant-tipo">
      <option value="Cambio de aceite">Cambio de aceite</option>
      <option value="Revisi√≥n ITV">Revisi√≥n ITV</option>
      <option value="Cambio de ruedas">Cambio de ruedas</option>
      <option value="Frenos">Frenos</option>
      <option value="Filtros">Filtros</option>
      <option value="Bater√≠a">Bater√≠a</option>
      <option value="Revisi√≥n general">Revisi√≥n general</option>
      <option value="Otro">Otro</option>
    </select></div>
    <div class="form-group"><label class="form-label">Descripci√≥n</label><input class="form-input" id="mant-desc" placeholder="Detalles del mantenimiento"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Km actuales</label><input class="form-input" type="number" id="mant-km" placeholder="85000"></div>
      <div class="form-group"><label class="form-label">Pr√≥ximos km</label><input class="form-input" type="number" id="mant-km-prox" placeholder="90000"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Coste (‚Ç¨)</label><input class="form-input" type="number" step="0.01" id="mant-coste" placeholder="0.00"></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-select" id="mant-estado"><option value="Programado">Programado</option><option value="Completado">Completado</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Taller / Proveedor</label><input class="form-input" id="mant-taller" placeholder="Ej: Taller Mart√≠nez"></div>
    <button class="btn-submit" onclick="guardarMantenimiento()">Guardar Mantenimiento</button>
    <button class="btn-cancel" onclick="closeModal('modal-mantenimiento')">Cancelar</button>
  </div>
</div>

<!-- MODAL USUARIO SISTEMA -->
<div class="modal-overlay" id="modal-sys-user" onclick="closeBg(event,'modal-sys-user')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-sys-user-title">üë§ Nuevo Usuario</div>
    <input type="hidden" id="sys-user-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre completo *</label><input class="form-input" id="sys-nombre" placeholder="Ej: Pere Mas"></div>
      <div class="form-group"><label class="form-label">Rol</label><select class="form-select" id="sys-role"><option value="chofer">üöê Chofer</option><option value="admin">üëë Admin</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Usuario *</label><input class="form-input" id="sys-user" placeholder="Ej: pere" autocomplete="off"></div>
      <div class="form-group"><label class="form-label">Contrase√±a *</label><input class="form-input" type="password" id="sys-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></div>
    </div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="sys-email" placeholder="correo@ejemplo.com"></div>
    <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="sys-tel" placeholder="600 000 000"></div>
    <button class="btn-submit" onclick="guardarSysUser()">Guardar Usuario</button>
    <button class="btn-cancel" onclick="closeModal('modal-sys-user')">Cancelar</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê AUTH ‚ïê‚ïê
const USERS=[
  {user:'admin', pass:'lobu2024', role:'admin',  nombre:'Administrador'},
  {user:'miquel',pass:'chofer1',  role:'chofer', nombre:'Miquel R.'},
  {user:'jordi', pass:'chofer2',  role:'chofer', nombre:'Jordi M.'},
  {user:'anna',  pass:'chofer3',  role:'chofer', nombre:'Anna P.'},
];
let currentUser=null;

function doLogin(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value;
  const found=USERS.find(x=>x.user===u&&x.pass===p);
  if(!found){document.getElementById('login-error').classList.add('show');document.getElementById('login-pass').value='';return;}
  currentUser=found;
  document.getElementById('login-error').classList.remove('show');
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('main-nav').style.display='flex';
  document.getElementById('header-user').innerHTML=`${found.role==='admin'?'üëë':'üë§'} ${found.nombre}`;
  const isAdmin = found.role==='admin';
  ['nav-revision','nav-informes','nav-admin'].forEach(id=>{
    document.getElementById(id).style.display=isAdmin?'flex':'none';
  });
  init();
}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('login-screen').style.display!=='none')doLogin();});

function doLogout(){
  currentUser=null;
  document.getElementById('app').style.display='none';
  document.getElementById('main-nav').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-user').value='';document.getElementById('login-pass').value='';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('nav-rutas').classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('sec-rutas').classList.add('active');
}

// ‚ïê‚ïê DATA ‚ïê‚ïê
let DB={
  rutas:[
    {id:1,nombre:'Ruta Ma√±ana ¬∑ Calonge',turno:'Ma√±ana',horaInicio:'07:30',centro:'Mar i Sol',grupoId:1,vehiculo:'1234-XYZ ¬∑ Furgoneta',km:22,tiempo:'40 min',obs:'',marcajes:{}},
    {id:2,nombre:'Ruta Ma√±ana ¬∑ Calella',turno:'Ma√±ana',horaInicio:'08:00',centro:'Can Clement',grupoId:2,vehiculo:'5678-ABC ¬∑ Minib√∫s',km:35,tiempo:'55 min',obs:'',marcajes:{}},
    {id:3,nombre:'Ruta Tarde ¬∑ Retornos',turno:'Tarde',horaInicio:'13:00',centro:'Mar i Sol',grupoId:1,vehiculo:'1234-XYZ ¬∑ Furgoneta',km:22,tiempo:'45 min',obs:'Retorno a domicilios',marcajes:{}},
  ],
  grupos:[
    {id:1,nombre:'Grupo Calonge',centro:'Mar i Sol',color:'#3A6B8A',obs:'Zona litoral'},
    {id:2,nombre:'Grupo Can Clement',centro:'Can Clement',color:'#4A7C59',obs:'Centro de d√≠a'},
    {id:3,nombre:'Grupo Calella',centro:'Calella CD',color:'#8B7332',obs:'50 plazas CD'},
  ],
  usuarios:[
    {id:1,nombre:'Rosa',apellidos:'Puig Vidal',dir:'C/ Narc√≠s Monturiol, 14 ¬∑ Sant Antoni',hora:'07:45',grupoId:1,obs:['Silla de ruedas'],tel:'972 000 111'},
    {id:2,nombre:'Joan',apellidos:'Mas Ferrer',dir:'Av. Catalunya, 32 ¬∑ Palam√≥s',hora:'07:58',grupoId:1,obs:[],tel:'972 000 222'},
    {id:3,nombre:'Maria',apellidos:'Soler Bou',dir:'Pl. Mol√≠, 5 ¬∑ Calonge',hora:'08:10',grupoId:2,obs:['Andador'],tel:'972 000 333'},
    {id:4,nombre:'Carmen',apellidos:'L√≥pez Ruiz',dir:'C/ Ponent, 8 ¬∑ Palam√≥s',hora:'13:00',grupoId:2,obs:[],tel:'972 000 444'},
    {id:5,nombre:'Francesc',apellidos:'Vila Puig',dir:'Rbla. Catalunya, 11 ¬∑ Calonge',hora:'13:15',grupoId:1,obs:['Ayuda embarque'],tel:'972 000 555'},
  ],
  historial:[
    {fecha:'2025-02-24',rutaId:1,turno:'Ma√±ana',conductor:'miquel',eventos:[{tipo:'recogidaUsuario',usuarioId:1,hora:'07:47'},{tipo:'recogidaUsuario',usuarioId:2,hora:'08:02'},{tipo:'llegadaCentro',hora:'08:35'}]},
    {fecha:'2025-02-24',rutaId:3,turno:'Tarde',conductor:'miquel',eventos:[{tipo:'recogidaGrupo',hora:'13:08'},{tipo:'llegadaDomicilio',usuarioId:5,hora:'13:22'},{tipo:'llegadaDomicilio',usuarioId:2,hora:'13:38'}]},
    {fecha:'2025-02-23',rutaId:1,turno:'Ma√±ana',conductor:'jordi',eventos:[{tipo:'recogidaUsuario',usuarioId:1,hora:'07:50'},{tipo:'recogidaUsuario',usuarioId:2,hora:'08:05'},{tipo:'llegadaCentro',hora:'08:42'}]},
    {fecha:'2025-02-23',rutaId:2,turno:'Ma√±ana',conductor:'anna',eventos:[{tipo:'recogidaUsuario',usuarioId:3,hora:'08:12'},{tipo:'llegadaCentro',hora:'09:10'}]},
  ],
  nextId:{rutas:4,grupos:4,usuarios:6},
};
let openCards={};let _filter='';let revFiltro='todas';

// ‚ïê‚ïê INIT ‚ïê‚ïê
function init(){
  const now=new Date();
  const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  const meses=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  document.getElementById('headerDate').innerHTML=`<strong>${dias[now.getDay()]}, ${now.getDate()} de ${meses[now.getMonth()]} ${now.getFullYear()}</strong> ¬∑ ${now.toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}`;
  renderAll();
}
function renderAll(){renderRutas();renderGrupos();renderUsuarios();renderOperativo();updateGrupoSelects();}

// ‚ïê‚ïê TAB ‚ïê‚ïê
function switchTab(name,btn){
  if((name==='revision'||name==='informes'||name==='admin')&&currentUser&&currentUser.role!=='admin'){showToast('üîí Solo acceso administrador');return;}
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='revision')renderRevision();
  else if(name==='vehiculo'){populateVehiculoSelects();renderVehiculo();}
  else if(name==='informes')renderInformes();
  else if(name==='admin')renderAdminPanel();
  else renderAll();
}

// ‚ïê‚ïê RUTAS ‚ïê‚ïê
function renderRutas(){
  document.getElementById('rutas-count').textContent=`${DB.rutas.length} rutas activas`;
  const ul=document.getElementById('rutas-lista');
  if(!DB.rutas.length){ul.innerHTML=`<div class="empty"><div class="empty-icon">üó∫Ô∏è</div><div class="empty-text">No hay rutas.</div></div>`;return;}
  ul.innerHTML=DB.rutas.map(r=>{
    const grupo=DB.grupos.find(g=>g.id===r.grupoId);
    const usuarios=DB.usuarios.filter(u=>u.grupoId===r.grupoId);
    const isOpen=openCards['r'+r.id];const done=isRutaCompleta(r);
    return `<div class="ruta-card">
      <div class="ruta-card-header" onclick="toggleCard('r${r.id}')">
        <div class="ruta-icon ${r.turno==='Ma√±ana'?'manana':'tarde'}">${r.turno==='Ma√±ana'?'üåÖ':'üåÜ'}</div>
        <div class="ruta-card-info">
          <div class="ruta-name">${r.nombre}</div>
          <div class="ruta-meta">${r.horaInicio} ¬∑ ${r.centro} ¬∑ ${r.vehiculo||'‚Äî'}</div>
          <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:4px">
            <span class="badge badge-gold">${r.turno}</span>
            ${grupo?`<span class="badge" style="background:${grupo.color}22;color:${grupo.color};border:1px solid ${grupo.color}44">${grupo.nombre}</span>`:''}
            <span class="badge ${done?'badge-green':'badge-warn'}">${done?'‚úì Completada':'Pendiente'}</span>
            <span class="badge badge-blue">${usuarios.length} usuarios</span>
            ${r.km?`<span class="badge badge-purple">üìç ${r.km}km</span>`:''}
          </div>
        </div>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="ruta-expand ${isOpen?'open':''}" id="rexp-${r.id}">
        ${usuarios.length?`<div style="margin-bottom:12px"><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-weight:600">Paradas ¬∑ Usuarios</div>${renderParadasRuta(r,usuarios)}</div>`:'<div style="font-size:13px;color:var(--muted);margin-bottom:12px">Sin usuarios en este grupo.</div>'}
        ${renderMarcajeBloque(r,usuarios)}
        ${r.obs?`<div style="margin-top:10px;padding:8px 12px;background:var(--warn-bg);border-radius:8px;font-size:12px;color:var(--warn)">‚ö†Ô∏è ${r.obs}</div>`:''}
        <div class="ruta-actions"><button class="btn-action primary" onclick="editRuta(${r.id})">‚úèÔ∏è Editar</button><button class="btn-action danger" onclick="deleteRuta(${r.id})">üóëÔ∏è Eliminar</button></div>
      </div>
    </div>`;
  }).join('');
}

function renderParadasRuta(r,usuarios){
  if(!usuarios.length)return'';
  const sorted=[...usuarios].sort((a,b)=>a.hora.localeCompare(b.hora));
  return sorted.map((u,i)=>`<div class="parada-row">
    <div class="parada-line"><div class="p-dot ${i===sorted.length-1?'destino':'activo'}"></div>${i<sorted.length-1?'<div class="p-connector"></div>':''}</div>
    <div class="parada-info"><div class="parada-nombre">${u.nombre} ${u.apellidos}</div><div class="parada-dir">${u.dir}</div><div class="parada-hora">${u.hora}</div>${u.obs&&u.obs.length?`<div style="margin-top:3px">${u.obs.map(o=>`<span class="obs-tag">‚ö†Ô∏è ${o}</span>`).join('')}</div>`:''}</div>
  </div>`).join('');
}

function renderMarcajeBloque(r,usuarios){
  const esTarde=r.turno==='Tarde';
  if(!esTarde){
    const marcL=r.marcajes&&r.marcajes.llegadaCentro;
    const recUsers=(r.marcajes&&r.marcajes.recogidaUsuarios)||{};
    const todosRecogidos=usuarios.length>0&&usuarios.every(u=>recUsers[u.id]);
    let html=`<div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-weight:600;margin-top:4px">üåÖ Ma√±ana ¬∑ Recogida por usuario</div>`;
    if(usuarios.length){const sorted=[...usuarios].sort((a,b)=>a.hora.localeCompare(b.hora));html+=sorted.map(u=>{const t=recUsers[u.id];return`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)"><div class="avatar" style="width:30px;height:30px;font-size:11px">${u.nombre[0]}${u.apellidos[0]}</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">${u.nombre} ${u.apellidos}</div><div style="font-size:11px;color:var(--muted)">${u.hora} ¬∑ ${u.dir}</div></div><button class="btn-marcaje btn-reco ${t?'done':''}" style="flex:0 0 auto;padding:7px 12px;font-size:12px" onclick="marcarUsuarioRecogida(${r.id},${u.id})">${t?`‚úì ${t}`:'üìç Recoger'}</button></div>`;}).join('');}
    html+=`<div style="margin-top:10px"><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:600">üè• Llegada al centro</div><button class="btn-marcaje btn-lleg ${marcL?'done':''}" style="width:100%" onclick="marcarGrupo(${r.id},'llegadaCentro')">üèÅ ${marcL?`Centro confirmado ¬∑ ${marcL}`:'Marcar llegada al centro'}</button>${marcL?`<div class="ts-label">Llegada: ${marcL}</div>`:''}${todosRecogidos&&!marcL?`<div style="margin-top:6px;font-size:12px;text-align:center;color:var(--green)">‚úÖ Todos recogidos</div>`:''}</div>`;
    return html;
  } else {
    const marcRG=r.marcajes&&r.marcajes.recogidaGrupo;
    const llegDom=(r.marcajes&&r.marcajes.llegadaDomicilios)||{};
    const todosEntregados=usuarios.length>0&&usuarios.every(u=>llegDom[u.id]);
    let html=`<div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:600;margin-top:4px">üåÜ Tarde ¬∑ Recogida de grupo en centro</div><button class="btn-marcaje btn-reco ${marcRG?'done':''}" style="width:100%;margin-bottom:4px" onclick="marcarGrupo(${r.id},'recogidaGrupo')">üöê ${marcRG?`Grupo recogido ¬∑ ${marcRG}`:'Marcar recogida grupo en centro'}</button>${marcRG?`<div class="ts-label" style="margin-bottom:10px">Recogida: ${marcRG}</div>`:''}`;
    html+=`<div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-weight:600">üè† Llegada a domicilio ¬∑ Por usuario</div>`;
    if(usuarios.length){const sorted=[...usuarios].sort((a,b)=>a.hora.localeCompare(b.hora));html+=sorted.map(u=>{const t=llegDom[u.id];const dis=!marcRG;return`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);${dis?'opacity:.5':''}"><div class="avatar" style="width:30px;height:30px;font-size:11px">${u.nombre[0]}${u.apellidos[0]}</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">${u.nombre} ${u.apellidos}</div><div style="font-size:11px;color:var(--muted)">${u.hora} ¬∑ ${u.dir}</div></div><button class="btn-marcaje btn-lleg ${t?'done':''}" style="flex:0 0 auto;padding:7px 12px;font-size:12px" ${dis?'disabled':''} onclick="marcarUsuarioDomicilio(${r.id},${u.id})">${t?`‚úì ${t}`:'üè† Dejar'}</button></div>`;}).join('');}
    if(todosEntregados)html+=`<div style="margin-top:8px;font-size:12px;text-align:center;color:var(--green)">‚úÖ Todos entregados</div>`;
    return html;
  }
}

function marcarGrupo(rutaId,tipo){
  const t=nowTime();const r=DB.rutas.find(x=>x.id===rutaId);
  if(!r.marcajes)r.marcajes={};r.marcajes[tipo]=t;
  logEvento(rutaId,tipo,t);
  showToast(tipo==='llegadaCentro'?`üè• Centro confirmado ¬∑ ${t}`:`üöê Grupo recogido ¬∑ ${t}`);
  renderRutas();renderOperativo();
}
function marcarUsuarioRecogida(rutaId,uid){
  const t=nowTime();const r=DB.rutas.find(x=>x.id===rutaId);
  if(!r.marcajes)r.marcajes={};if(!r.marcajes.recogidaUsuarios)r.marcajes.recogidaUsuarios={};
  r.marcajes.recogidaUsuarios[uid]=t;
  const u=DB.usuarios.find(x=>x.id===uid);logEvento(rutaId,'recogidaUsuario',t,uid);
  showToast(`üìç ${u?u.nombre+' '+u.apellidos:'Usuario'} recogido ¬∑ ${t}`);
  renderRutas();renderOperativo();
}
function marcarUsuarioDomicilio(rutaId,uid){
  const t=nowTime();const r=DB.rutas.find(x=>x.id===rutaId);
  if(!r.marcajes)r.marcajes={};if(!r.marcajes.llegadaDomicilios)r.marcajes.llegadaDomicilios={};
  r.marcajes.llegadaDomicilios[uid]=t;
  const u=DB.usuarios.find(x=>x.id===uid);logEvento(rutaId,'llegadaDomicilio',t,uid);
  showToast(`üè† ${u?u.nombre+' '+u.apellidos:'Usuario'} entregado ¬∑ ${t}`);
  renderRutas();renderOperativo();
}
function logEvento(rutaId,tipo,hora,usuarioId){
  const hoy=new Date().toISOString().split('T')[0];
  let reg=DB.historial.find(h=>h.fecha===hoy&&h.rutaId===rutaId);
  const r=DB.rutas.find(x=>x.id===rutaId);
  if(!reg){reg={fecha:hoy,rutaId,turno:r?r.turno:'',conductor:currentUser?currentUser.user:'',eventos:[]};DB.historial.push(reg);}
  reg.eventos.push({tipo,hora,...(usuarioId?{usuarioId}:{})});
}

function editRuta(id){const r=DB.rutas.find(x=>x.id===id);document.getElementById('modal-ruta-title').textContent='Editar Ruta';document.getElementById('ruta-edit-id').value=id;document.getElementById('ruta-nombre').value=r.nombre;document.getElementById('ruta-turno').value=r.turno;document.getElementById('ruta-hora-inicio').value=r.horaInicio;document.getElementById('ruta-centro').value=r.centro;document.getElementById('ruta-grupo-sel').value=r.grupoId||'';document.getElementById('ruta-vehiculo').value=r.vehiculo||'';document.getElementById('ruta-km').value=r.km||'';document.getElementById('ruta-tiempo').value=r.tiempo||'';document.getElementById('ruta-obs').value=r.obs||'';openModal('modal-ruta');}
function deleteRuta(id){if(!confirm('¬øEliminar esta ruta?'))return;DB.rutas=DB.rutas.filter(r=>r.id!==id);showToast('üóëÔ∏è Ruta eliminada');renderRutas();renderOperativo();}
function guardarRuta(){
  const nombre=document.getElementById('ruta-nombre').value.trim();if(!nombre){showToast('‚ö†Ô∏è Nombre obligatorio');return;}
  const editId=parseInt(document.getElementById('ruta-edit-id').value||0);
  const data={nombre,turno:document.getElementById('ruta-turno').value,horaInicio:document.getElementById('ruta-hora-inicio').value,centro:document.getElementById('ruta-centro').value,grupoId:parseInt(document.getElementById('ruta-grupo-sel').value)||null,vehiculo:document.getElementById('ruta-vehiculo').value.trim(),km:parseInt(document.getElementById('ruta-km').value)||0,tiempo:document.getElementById('ruta-tiempo').value.trim(),obs:document.getElementById('ruta-obs').value.trim()};
  if(editId){const i=DB.rutas.findIndex(r=>r.id===editId);DB.rutas[i]={...DB.rutas[i],...data};showToast('‚úÖ Ruta actualizada');}
  else{data.id=DB.nextId.rutas++;data.marcajes={};DB.rutas.push(data);showToast('‚úÖ Ruta creada');}
  closeModal('modal-ruta');renderAll();
}

// ‚ïê‚ïê GRUPOS ‚ïê‚ïê
function renderGrupos(){
  document.getElementById('grupos-count').textContent=`${DB.grupos.length} grupos`;const ul=document.getElementById('grupos-lista');
  if(!DB.grupos.length){ul.innerHTML=`<div class="empty"><div class="empty-icon">üë•</div><div class="empty-text">Sin grupos.</div></div>`;return;}
  ul.innerHTML=DB.grupos.map(g=>{const miembros=DB.usuarios.filter(u=>u.grupoId===g.id);const isOpen=openCards['g'+g.id];return`<div class="grupo-card">
    <div class="grupo-header" onclick="toggleCard('g${g.id}')"><div class="grupo-dot" style="background:${g.color}"></div><div class="grupo-info"><div class="grupo-name">${g.nombre}</div><div class="grupo-meta">${g.centro} ¬∑ ${miembros.length} usuario${miembros.length!==1?'s':''}</div></div><div style="display:flex;gap:6px;align-items:center"><span class="badge" style="background:${g.color}22;color:${g.color};border:1px solid ${g.color}44">${miembros.length}</span><span class="chevron ${isOpen?'open':''}">‚ñæ</span></div></div>
    <div class="grupo-expand ${isOpen?'open':''}" id="gexp-${g.id}">${g.obs?`<div style="font-size:12px;color:var(--muted);margin-bottom:10px">üìù ${g.obs}</div>`:''}${miembros.length?miembros.map(u=>`<div class="usuario-mini"><div class="avatar">${u.nombre[0]}${u.apellidos[0]}</div><div style="flex:1"><div style="font-size:13px;font-weight:600">${u.nombre} ${u.apellidos}</div><div style="font-size:11px;color:var(--muted)">${u.dir}</div></div><span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold)">${u.hora}</span></div>`).join(''):'<div style="font-size:13px;color:var(--muted);padding:8px 0">Sin usuarios</div>'}
    <div class="ruta-actions" style="margin-top:12px"><button class="btn-action primary" onclick="editGrupo(${g.id})">‚úèÔ∏è Editar</button><button class="btn-action danger" onclick="deleteGrupo(${g.id})">üóëÔ∏è Eliminar</button></div></div>
  </div>`;}).join('');
}
function editGrupo(id){const g=DB.grupos.find(x=>x.id===id);document.getElementById('modal-grupo-title').textContent='Editar Grupo';document.getElementById('grupo-edit-id').value=id;document.getElementById('grupo-nombre').value=g.nombre;document.getElementById('grupo-centro').value=g.centro;document.getElementById('grupo-color').value=g.color;document.getElementById('grupo-obs').value=g.obs||'';openModal('modal-grupo');}
function deleteGrupo(id){if(!confirm('¬øEliminar grupo?'))return;DB.grupos=DB.grupos.filter(g=>g.id!==id);DB.usuarios.forEach(u=>{if(u.grupoId===id)u.grupoId=null;});showToast('üóëÔ∏è Grupo eliminado');renderAll();}
function guardarGrupo(){const nombre=document.getElementById('grupo-nombre').value.trim();if(!nombre){showToast('‚ö†Ô∏è Nombre obligatorio');return;}const editId=parseInt(document.getElementById('grupo-edit-id').value||0);const data={nombre,centro:document.getElementById('grupo-centro').value,color:document.getElementById('grupo-color').value,obs:document.getElementById('grupo-obs').value.trim()};if(editId){const i=DB.grupos.findIndex(g=>g.id===editId);DB.grupos[i]={...DB.grupos[i],...data};showToast('‚úÖ Grupo actualizado');}else{data.id=DB.nextId.grupos++;DB.grupos.push(data);showToast('‚úÖ Grupo creado');}closeModal('modal-grupo');renderAll();}

// ‚ïê‚ïê USUARIOS ‚ïê‚ïê
function filterUsuarios(q){_filter=q.toLowerCase();renderUsuarios();}
function renderUsuarios(){
  const usuarios=DB.usuarios.filter(u=>!_filter||`${u.nombre} ${u.apellidos} ${u.dir}`.toLowerCase().includes(_filter));
  document.getElementById('usuarios-count').textContent=`${DB.usuarios.length} usuarios ¬∑ ${usuarios.length} mostrados`;
  const ul=document.getElementById('usuarios-lista');
  if(!usuarios.length){ul.innerHTML=`<div class="empty"><div class="empty-icon">üë§</div><div class="empty-text">No encontrado.</div></div>`;return;}
  const colors=['#B8963E','#3A6B8A','#4A7C59','#8B4040','#6B4A8B','#4A6B8B'];
  ul.innerHTML=usuarios.map((u,idx)=>{const grupo=DB.grupos.find(g=>g.id===u.grupoId);const isOpen=openCards['u'+u.id];const col=grupo?grupo.color:colors[idx%colors.length];return`<div class="usuario-card">
    <div class="usuario-header" onclick="toggleCard('u${u.id}')"><div class="avatar-lg" style="background:${col}22;border-color:${col}66;color:${col}">${u.nombre[0]}${u.apellidos[0]}</div><div class="u-info"><div class="u-name">${u.nombre} ${u.apellidos}</div><div class="u-meta">${u.dir}</div><div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:4px">${grupo?`<span class="badge" style="background:${grupo.color}22;color:${grupo.color};border:1px solid ${grupo.color}44">${grupo.nombre}</span>`:'<span class="badge badge-warn">Sin grupo</span>'}<span class="badge badge-gold">üïê ${u.hora}</span>${u.obs&&u.obs.length?u.obs.map(o=>`<span class="badge badge-warn">‚ö†Ô∏è ${o}</span>`).join(''):''}</div></div><span class="chevron ${isOpen?'open':''}">‚ñæ</span></div>
    <div class="usuario-expand ${isOpen?'open':''}" id="uexp-${u.id}"><div class="u-detail-row"><span class="u-detail-label">Direcci√≥n</span><span class="u-detail-val">${u.dir}</span></div><div class="u-detail-row"><span class="u-detail-label">Hora</span><span class="u-detail-val" style="font-family:'DM Mono',monospace">${u.hora}</span></div><div class="u-detail-row"><span class="u-detail-label">Grupo</span><span class="u-detail-val">${grupo?grupo.nombre:'‚Äî'}</span></div><div class="u-detail-row"><span class="u-detail-label">Tel.</span><span class="u-detail-val">${u.tel||'‚Äî'}</span></div>${u.obs&&u.obs.length?`<div class="u-detail-row"><span class="u-detail-label">Necesidades</span><span class="u-detail-val">${u.obs.map(o=>`<span class="obs-tag">‚ö†Ô∏è ${o}</span>`).join('')}</span></div>`:''}
    <div class="ruta-actions"><button class="btn-action primary" onclick="editUsuario(${u.id})">‚úèÔ∏è Editar</button><button class="btn-action danger" onclick="deleteUsuario(${u.id})">üóëÔ∏è Eliminar</button></div></div>
  </div>`;}).join('');
}
function editUsuario(id){const u=DB.usuarios.find(x=>x.id===id);document.getElementById('modal-usuario-title').textContent='Editar Usuario';document.getElementById('usuario-edit-id').value=id;document.getElementById('u-nombre').value=u.nombre;document.getElementById('u-apellidos').value=u.apellidos;document.getElementById('u-dir').value=u.dir;document.getElementById('u-hora').value=u.hora;document.getElementById('u-grupo').value=u.grupoId||'';document.getElementById('u-tel').value=u.tel||'';document.getElementById('obs-silla').checked=u.obs&&u.obs.includes('Silla de ruedas');document.getElementById('obs-andador').checked=u.obs&&u.obs.includes('Andador');document.getElementById('obs-oxigeno').checked=u.obs&&u.obs.includes('Ox√≠geno');document.getElementById('obs-ayuda').checked=u.obs&&u.obs.includes('Ayuda embarque');openModal('modal-usuario');}
function deleteUsuario(id){if(!confirm('¬øEliminar usuario?'))return;DB.usuarios=DB.usuarios.filter(u=>u.id!==id);showToast('üóëÔ∏è Usuario eliminado');renderAll();}
function guardarUsuario(){const nombre=document.getElementById('u-nombre').value.trim();const apellidos=document.getElementById('u-apellidos').value.trim();const dir=document.getElementById('u-dir').value.trim();if(!nombre||!apellidos||!dir){showToast('‚ö†Ô∏è Campos obligatorios');return;}const obs=[];if(document.getElementById('obs-silla').checked)obs.push('Silla de ruedas');if(document.getElementById('obs-andador').checked)obs.push('Andador');if(document.getElementById('obs-oxigeno').checked)obs.push('Ox√≠geno');if(document.getElementById('obs-ayuda').checked)obs.push('Ayuda embarque');const editId=parseInt(document.getElementById('usuario-edit-id').value||0);const data={nombre,apellidos,dir,hora:document.getElementById('u-hora').value,grupoId:parseInt(document.getElementById('u-grupo').value)||null,tel:document.getElementById('u-tel').value.trim(),obs};if(editId){const i=DB.usuarios.findIndex(u=>u.id===editId);DB.usuarios[i]={...DB.usuarios[i],...data};showToast('‚úÖ Actualizado');}else{data.id=DB.nextId.usuarios++;DB.usuarios.push(data);showToast('‚úÖ Creado');}closeModal('modal-usuario');renderAll();}

// ‚ïê‚ïê OPERATIVO ‚ïê‚ïê
function isRutaCompleta(r){
  const usuarios=DB.usuarios.filter(u=>u.grupoId===r.grupoId);
  if(r.turno==='Tarde'){const marcRG=r.marcajes&&r.marcajes.recogidaGrupo;const llegDom=(r.marcajes&&r.marcajes.llegadaDomicilios)||{};return marcRG&&(usuarios.length===0||usuarios.every(u=>llegDom[u.id]));}
  else{const recUsers=(r.marcajes&&r.marcajes.recogidaUsuarios)||{};const marcLC=r.marcajes&&r.marcajes.llegadaCentro;return marcLC&&(usuarios.length===0||usuarios.every(u=>recUsers[u.id]));}
}
function renderOperativo(){
  const total=DB.rutas.length;const done=DB.rutas.filter(r=>isRutaCompleta(r)).length;const pax=DB.usuarios.length;const pct=total?Math.round((done/total)*100):0;
  document.getElementById('op-total').textContent=total;document.getElementById('op-done').textContent=done;document.getElementById('op-pax').textContent=pax;document.getElementById('op-pct').textContent=pct+'%';document.getElementById('op-bar').style.width=pct+'%';
  const lista=document.getElementById('op-rutas-lista');
  if(!DB.rutas.length){lista.innerHTML=`<div class="empty"><div class="empty-icon">üèÅ</div><div class="empty-text">Sin rutas.</div></div>`;return;}
  lista.innerHTML=DB.rutas.map(r=>{const grupo=DB.grupos.find(g=>g.id===r.grupoId);const esTarde=r.turno==='Tarde';const completa=isRutaCompleta(r);const usuarios=DB.usuarios.filter(u=>u.grupoId===r.grupoId);
    let prog='';if(esTarde){const mRG=r.marcajes&&r.marcajes.recogidaGrupo;const lD=(r.marcajes&&r.marcajes.llegadaDomicilios)||{};prog=`${mRG?'üöê Recogida ‚úì':'üöê Recogida ‚óã'} ¬∑ üè† ${usuarios.filter(u=>lD[u.id]).length}/${usuarios.length} domicilios`;}
    else{const rU=(r.marcajes&&r.marcajes.recogidaUsuarios)||{};const mLC=r.marcajes&&r.marcajes.llegadaCentro;prog=`üìç ${usuarios.filter(u=>rU[u.id]).length}/${usuarios.length} recogidos ¬∑ ${mLC?'üè• Centro ‚úì':'üè• Centro ‚óã'}`;}
    return`<div class="card" style="border-left:4px solid ${completa?'var(--green)':'var(--border)'}"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><div style="font-weight:700;font-size:14px">${esTarde?'üåÜ':'üåÖ'} ${r.nombre}</div><span class="badge ${completa?'badge-green':'badge-warn'}">${completa?'‚úì Completa':'En curso'}</span></div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">${r.horaInicio} ¬∑ ${r.centro} ${grupo?'¬∑ '+grupo.nombre:''}</div><div style="font-size:12px;color:var(--text2);padding:6px 10px;background:var(--surface2);border-radius:8px">${prog}</div></div>`;
  }).join('');
}

// ‚ïê‚ïê REVISI√ìN ADMIN ‚ïê‚ïê
function renderRevision(){
  if(!currentUser||currentUser.role!=='admin'){
    document.getElementById('revision-content').innerHTML=`<div class="access-denied"><div style="font-size:64px;margin-bottom:16px">üîí</div><div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--red);margin-bottom:8px">Acceso Restringido</div><div style="font-size:14px;color:var(--muted)">Solo para administradores</div></div>`;
    return;
  }
  const totalKm=DB.rutas.reduce((s,r)=>s+(r.km||0),0);
  const completadas=DB.rutas.filter(r=>isRutaCompleta(r)).length;
  const durations=[];
  DB.historial.forEach(h=>{if(h.eventos.length>=2){const ts=h.eventos.map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));if(ts.length>=2)durations.push(Math.max(...ts)-Math.min(...ts));}});
  const durMedia=durations.length?Math.round(durations.reduce((s,d)=>s+d,0)/durations.length):null;
  const incidencias=DB.historial.filter(h=>{return h.eventos.some(e=>{if(!e.usuarioId)return false;const u=DB.usuarios.find(x=>x.id===e.usuarioId);const r=DB.rutas.find(x=>x.id===h.rutaId);if(!u||!r||r.turno==='Tarde')return false;return timeToMin(e.hora)>timeToMin(u.hora)+5;});}).length;

  document.getElementById('revision-content').innerHTML=`
  <div class="sec-head"><div><div class="sec-title">Revisi√≥n</div><div class="sec-sub">An√°lisis y control</div></div></div>
  <div class="admin-badge">üëë ${currentUser.nombre} ¬∑ Administrador</div>

  <div class="rev-kpi-row">
    <div class="rev-kpi"><div class="rev-kpi-n" style="color:var(--blue)">${DB.rutas.length}</div><div class="rev-kpi-l">Rutas activas</div></div>
    <div class="rev-kpi"><div class="rev-kpi-n" style="color:var(--green)">${completadas}/${DB.rutas.length}</div><div class="rev-kpi-l">Completadas hoy</div></div>
    <div class="rev-kpi"><div class="rev-kpi-n" style="color:var(--gold)">${DB.usuarios.length}</div><div class="rev-kpi-l">Usuarios activos</div></div>
    <div class="rev-kpi"><div class="rev-kpi-n" style="color:var(--purple)">${totalKm}<span style="font-size:13px">km</span></div><div class="rev-kpi-l">Km/d√≠a estimados</div></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
    ${durMedia!==null?`<div class="card" style="margin-bottom:0;display:flex;align-items:center;gap:10px"><div style="font-size:24px">‚è±Ô∏è</div><div><div style="font-weight:700;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Duraci√≥n media</div><div style="font-family:'DM Mono',monospace;font-size:22px;color:var(--purple)">${durMedia}<span style="font-size:13px"> min</span></div></div></div>`:''}
    <div class="card" style="margin-bottom:0;display:flex;align-items:center;gap:10px"><div style="font-size:24px">${incidencias>0?'‚ö†Ô∏è':'‚úÖ'}</div><div><div style="font-weight:700;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Retrasos</div><div style="font-family:'DM Mono',monospace;font-size:22px;color:${incidencias>0?'var(--warn)':'var(--green)'}">${incidencias}<span style="font-size:13px"> eventos</span></div></div></div>
  </div>

  <div style="font-family:'Playfair Display',serif;font-size:16px;font-weight:700;margin-bottom:10px">Estado de rutas ¬∑ Hoy</div>
  ${renderRevRutas()}

  <div style="font-family:'Playfair Display',serif;font-size:16px;font-weight:700;margin:16px 0 10px">Historial de trayectos</div>
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
    <div class="filter-pill ${revFiltro==='todas'?'active':''}" onclick="setRevFiltro('todas')">Todos</div>
    <div class="filter-pill ${revFiltro==='manana'?'active':''}" onclick="setRevFiltro('manana')">üåÖ Ma√±ana</div>
    <div class="filter-pill ${revFiltro==='tarde'?'active':''}" onclick="setRevFiltro('tarde')">üåÜ Tarde</div>
  </div>
  ${renderHistorial()}`;
}

function setRevFiltro(f){revFiltro=f;renderRevision();}

function renderRevRutas(){
  return DB.rutas.map(r=>{
    const esTarde=r.turno==='Tarde';const usuarios=DB.usuarios.filter(u=>u.grupoId===r.grupoId);const completa=isRutaCompleta(r);
    let marcados=0;const total=usuarios.length+1;
    if(esTarde){const mRG=r.marcajes&&r.marcajes.recogidaGrupo;const lD=(r.marcajes&&r.marcajes.llegadaDomicilios)||{};marcados=(mRG?1:0)+usuarios.filter(u=>lD[u.id]).length;}
    else{const rU=(r.marcajes&&r.marcajes.recogidaUsuarios)||{};const mLC=r.marcajes&&r.marcajes.llegadaCentro;marcados=usuarios.filter(u=>rU[u.id]).length+(mLC?1:0);}
    const pct=total>0?Math.round((marcados/total)*100):0;
    const estado=completa?'completa':marcados>0?'parcial':'sin';
    const isOpen=openCards['rev'+r.id];
    return`<div class="rev-card">
      <div class="rev-card-head ${estado}" onclick="toggleCard('rev${r.id}')">
        <div style="font-size:20px">${esTarde?'üåÜ':'üåÖ'}</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:14px">${r.nombre}</div>
          <div style="font-size:12px;color:var(--muted)">${r.horaInicio} ¬∑ ${r.vehiculo||'‚Äî'}${r.km?' ¬∑ '+r.km+'km':''}${r.tiempo?' ¬∑ ~'+r.tiempo:''}</div>
          <div style="margin-top:6px"><div style="background:var(--cream2);border-radius:4px;height:5px;overflow:hidden"><div style="height:100%;border-radius:4px;background:${completa?'var(--green)':'var(--gold)'};width:${pct}%"></div></div><div style="font-size:11px;color:var(--muted);margin-top:3px">${marcados}/${total} pasos ¬∑ ${pct}%</div></div>
        </div>
        <span class="badge ${completa?'badge-green':marcados>0?'badge-warn':'badge-red'}">${completa?'‚úì OK':marcados>0?'Parcial':'Sin datos'}</span>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="rev-expand ${isOpen?'open':''}">${renderTimelineRuta(r,usuarios)}</div>
    </div>`;
  }).join('');
}

function renderTimelineRuta(r,usuarios){
  const esTarde=r.turno==='Tarde';const eventos=[];
  if(esTarde){const mRG=r.marcajes&&r.marcajes.recogidaGrupo;const lD=(r.marcajes&&r.marcajes.llegadaDomicilios)||{};
    eventos.push({emoji:'üöê',titulo:'Recogida grupo en centro',hora:mRG,ok:!!mRG});
    usuarios.sort((a,b)=>a.hora.localeCompare(b.hora)).forEach(u=>{const t=lD[u.id];eventos.push({emoji:'üè†',titulo:`${u.nombre} ${u.apellidos}`,sub:u.dir,hora:t,ok:!!t});});
  } else {
    const rU=(r.marcajes&&r.marcajes.recogidaUsuarios)||{};const mLC=r.marcajes&&r.marcajes.llegadaCentro;
    usuarios.sort((a,b)=>a.hora.localeCompare(b.hora)).forEach(u=>{const t=rU[u.id];eventos.push({emoji:'üìç',titulo:`Recoger ${u.nombre} ${u.apellidos}`,sub:u.dir,horaP:u.hora,hora:t,ok:!!t});});
    eventos.push({emoji:'üè•',titulo:`Llegada a ${r.centro}`,hora:mLC,ok:!!mLC});
  }
  const ts=eventos.filter(e=>e.hora).map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));
  const dur=ts.length>=2?Math.max(...ts)-Math.min(...ts):null;
  return`<div style="margin-top:4px">
    ${eventos.map(e=>`<div class="rev-event">
      <div class="rev-time">${e.hora||e.horaP||'‚Äî'}</div>
      <div class="rev-dot ${e.ok?'ok':'pending'}" style="margin-top:4px;flex-shrink:0"></div>
      <div style="flex:1"><div class="rev-ev-title">${e.emoji} ${e.titulo}</div>${e.sub?`<div class="rev-ev-sub">${e.sub}</div>`:''}${e.hora&&e.horaP?`<div style="font-size:11px;margin-top:2px">Prev: ${e.horaP} ¬∑ Real: ${e.hora} <span style="color:${timeToMin(e.hora)<=timeToMin(e.horaP)?'var(--green)':'var(--red)'}">${timeToMin(e.hora)<=timeToMin(e.horaP)?'‚úì Puntual':'‚ö†Ô∏è +'+(timeToMin(e.hora)-timeToMin(e.horaP))+' min'}</span></div>`:''}
      </div>
    </div>`).join('')}
    ${dur!==null?`<div style="padding:8px 0"><span class="rev-duracion">‚è±Ô∏è Duraci√≥n: ${dur} min</span>${r.km?` <span style="font-size:12px;color:var(--muted);margin-left:8px">üìç ${r.km}km estimados</span>`:''}</div>`:''}
  </div>`;
}

function renderHistorial(){
  const filtradas=DB.historial.filter(h=>{if(revFiltro==='manana')return h.turno==='Ma√±ana';if(revFiltro==='tarde')return h.turno==='Tarde';return true;});
  const fechas=[...new Set(filtradas.map(h=>h.fecha))].sort().reverse();
  if(!fechas.length)return`<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">Sin historial</div></div>`;
  return fechas.map(fecha=>{
    const regs=filtradas.filter(h=>h.fecha===fecha);
    return`<div class="card"><div style="font-weight:700;font-size:14px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between"><span>üìÖ ${fmtFecha(fecha)}</span><span class="badge badge-blue">${regs.length} ruta${regs.length!==1?'s':''}</span></div>
    ${regs.map(h=>{const r=DB.rutas.find(x=>x.id===h.rutaId);if(!r)return'';const ts=h.eventos.map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));const dur=ts.length>=2?Math.max(...ts)-Math.min(...ts):null;
      return`<div style="padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
          <div style="font-weight:600;font-size:13px">${h.turno==='Tarde'?'üåÜ':'üåÖ'} ${r.nombre}</div>
          <div style="display:flex;gap:6px">
            ${dur!==null?`<span class="rev-duracion">‚è±Ô∏è ${dur}min</span>`:''}
            ${h.conductor?`<span class="badge badge-gold">üë§ ${h.conductor}</span>`:''}
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">${h.eventos.length} eventos registrados</div>
        ${h.eventos.map(e=>{const u=e.usuarioId?DB.usuarios.find(x=>x.id===e.usuarioId):null;const labels={recogidaUsuario:'üìç',llegadaCentro:'üè•',recogidaGrupo:'üöê',llegadaDomicilio:'üè†'};
          return`<div style="display:flex;gap:8px;font-size:12px;padding:3px 0"><span style="font-family:'DM Mono',monospace;color:var(--gold);min-width:38px">${e.hora}</span><span>${labels[e.tipo]||'‚óã'} ${e.tipo.replace('recogidaUsuario','Recogida').replace('llegadaCentro','Centro').replace('recogidaGrupo','Grupo').replace('llegadaDomicilio','Domicilio')}</span>${u?`<span style="font-weight:600">${u.nombre} ${u.apellidos}</span>`:''}</div>`;
        }).join('')}
      </div>`;}).join('')}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function timeToMin(t){if(!t)return NaN;const[h,m]=t.split(':').map(Number);return h*60+m;}
function nowTime(){const n=new Date();return`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}
function fmtFecha(f){const[y,m,d]=f.split('-');const ms=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];return`${parseInt(d)} de ${ms[parseInt(m)-1]} ${y}`;}

function updateGrupoSelects(){const opts=DB.grupos.map(g=>`<option value="${g.id}">${g.nombre}</option>`).join('');document.getElementById('ruta-grupo-sel').innerHTML=`<option value="">-- Sin grupo --</option>${opts}`;document.getElementById('u-grupo').innerHTML=`<option value="">-- Sin grupo --</option>${opts}`;}
function toggleCard(key){openCards[key]=!openCards[key];const sec=document.querySelector('.section.active');if(sec&&sec.id==='sec-revision')renderRevision();else if(sec&&sec.id==='sec-vehiculo')renderVehiculo();else if(sec&&sec.id==='sec-admin')renderAdminPanel();else renderAll();}
function openModalNew(id){
  const hidMap={'modal-ruta':'ruta-edit-id','modal-grupo':'grupo-edit-id','modal-usuario':'usuario-edit-id','modal-repostaje':'rep-edit-id','modal-incidencia':'inc-edit-id','modal-mantenimiento':'mant-edit-id'};
  if(hidMap[id])document.getElementById(hidMap[id]).value='';
  if(id==='modal-repostaje'){document.getElementById('modal-repostaje-title').textContent='‚õΩ Nuevo Repostaje';['rep-km','rep-litros','rep-precio','rep-importe','rep-gasolinera','rep-obs'].forEach(f=>document.getElementById(f).value='');document.getElementById('rep-fecha').value=new Date().toISOString().split('T')[0];}
  if(id==='modal-incidencia'){document.getElementById('modal-incidencia-title').textContent='‚ö†Ô∏è Nueva Incidencia';['inc-desc','inc-km','inc-obs'].forEach(f=>document.getElementById(f).value='');document.getElementById('inc-fecha').value=new Date().toISOString().split('T')[0];document.getElementById('inc-gravedad').value='Media';document.getElementById('inc-estado').value='Pendiente';}
  if(id==='modal-mantenimiento'){document.getElementById('modal-mant-title').textContent='üîß Nuevo Mantenimiento';['mant-desc','mant-km','mant-km-prox','mant-coste','mant-taller'].forEach(f=>document.getElementById(f).value='');document.getElementById('mant-fecha').value=new Date().toISOString().split('T')[0];document.getElementById('mant-estado').value='Programado';}
  populateVehiculoSelects();
  openModal(id);
}
function openModal(id){
  if(id==='modal-ruta'&&!document.getElementById('ruta-edit-id').value){document.getElementById('modal-ruta-title').textContent='Nueva Ruta';['ruta-nombre','ruta-vehiculo','ruta-obs','ruta-tiempo'].forEach(f=>document.getElementById(f).value='');document.getElementById('ruta-hora-inicio').value='07:30';document.getElementById('ruta-km').value='';}
  if(id==='modal-grupo'&&!document.getElementById('grupo-edit-id').value){document.getElementById('modal-grupo-title').textContent='Nuevo Grupo';['grupo-nombre','grupo-obs'].forEach(f=>document.getElementById(f).value='');}
  if(id==='modal-usuario'&&!document.getElementById('usuario-edit-id').value){document.getElementById('modal-usuario-title').textContent='Nuevo Usuario';['u-nombre','u-apellidos','u-dir','u-tel','u-obs'].forEach(f=>document.getElementById(f).value='');document.getElementById('u-hora').value='08:00';['obs-silla','obs-andador','obs-oxigeno','obs-ayuda'].forEach(f=>document.getElementById(f).checked=false);}
  updateGrupoSelects();document.getElementById(id).classList.add('open');
}
function closeModal(id){document.getElementById(id).classList.remove('open');const m={'modal-ruta':'ruta-edit-id','modal-grupo':'grupo-edit-id','modal-usuario':'usuario-edit-id','modal-repostaje':'rep-edit-id','modal-incidencia':'inc-edit-id','modal-mantenimiento':'mant-edit-id'};if(m[id])document.getElementById(m[id]).value='';}
function closeBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(window._tt);window._tt=setTimeout(()=>t.classList.remove('show'),2500);}

// ‚ïê‚ïê VEH√çCULOS ‚ïê‚ïê
// Flota de veh√≠culos (matr√≠cula / nombre)
const FLOTA=[
  {id:'1234-XYZ',nombre:'Furgoneta 1234-XYZ'},
  {id:'5678-ABC',nombre:'Minib√∫s 5678-ABC'},
  {id:'9012-DEF',nombre:'Furgoneta 9012-DEF'},
];

// Extender DB con datos de veh√≠culo
DB.repostajes=[
  {id:1,fecha:'2025-02-20',vehiculo:'1234-XYZ',km:84320,litros:52.3,precio:1.659,importe:86.76,gasolinera:'Repsol Palam√≥s',obs:'',conductor:'miquel'},
  {id:2,fecha:'2025-02-22',vehiculo:'5678-ABC',km:62100,litros:68.5,precio:1.672,importe:114.53,gasolinera:'BP Calella',obs:'Tanque lleno',conductor:'jordi'},
  {id:3,fecha:'2025-02-24',vehiculo:'1234-XYZ',km:84650,litros:45.1,precio:1.648,importe:74.32,gasolinera:'Repsol Palam√≥s',obs:'',conductor:'anna'},
];
DB.incidencias=[
  {id:1,fecha:'2025-02-18',vehiculo:'5678-ABC',desc:'Luz testigo motor encendida',gravedad:'Alta',estado:'En curso',km:61900,obs:'Cita en taller el lunes',conductor:'jordi'},
  {id:2,fecha:'2025-02-21',vehiculo:'1234-XYZ',desc:'Limpiaparabrisas delantero roto',gravedad:'Baja',estado:'Resuelto',km:84100,obs:'Reemplazado en gasolinera',conductor:'miquel'},
];
DB.mantenimientos=[
  {id:1,fecha:'2025-02-10',vehiculo:'1234-XYZ',tipo:'Cambio de aceite',desc:'Aceite 5W30 + filtro aceite',km:84000,kmProx:89000,coste:85.00,estado:'Completado',taller:'Taller Mart√≠nez'},
  {id:2,fecha:'2025-03-15',vehiculo:'5678-ABC',tipo:'Revisi√≥n ITV',desc:'ITV obligatoria anual',km:62500,kmProx:null,coste:45.00,estado:'Programado',taller:'ITV Girona'},
];
DB.nextId.repostajes=4; DB.nextId.incidencias=3; DB.nextId.mantenimientos=3;
let vehTab='gasoil';

function renderVehiculo(){
  const totalGasoil=DB.repostajes.reduce((s,r)=>s+r.importe,0);
  const totalMant=DB.mantenimientos.reduce((s,m)=>s+(m.coste||0),0);
  const incPend=DB.incidencias.filter(i=>i.estado!=='Resuelto').length;

  document.getElementById('vehiculo-content').innerHTML=`
  <div class="sec-head"><div><div class="sec-title">Veh√≠culo</div><div class="sec-sub">Flota Group Lobu</div></div></div>

  <div class="veh-kpi-row">
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--warn)">‚õΩ</div><div class="veh-kpi-l" style="margin-top:2px">Gasoil</div><div style="font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--warn);margin-top:2px">${totalGasoil.toFixed(2)}‚Ç¨</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--red)">${incPend}</div><div class="veh-kpi-l">Incid. abiertas</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--green)">${totalMant.toFixed(0)}‚Ç¨</div><div class="veh-kpi-l">Mant. total</div></div>
  </div>

  <div class="veh-tabs">
    <div class="veh-tab ${vehTab==='gasoil'?'active':''}" onclick="switchVehTab('gasoil')">‚õΩ Gasoil</div>
    <div class="veh-tab ${vehTab==='incidencias'?'active':''}" onclick="switchVehTab('incidencias')">‚ö†Ô∏è Incidencias</div>
    <div class="veh-tab ${vehTab==='mantenimiento'?'active':''}" onclick="switchVehTab('mantenimiento')">üîß Mantenimiento</div>
  </div>

  <div class="veh-panel ${vehTab==='gasoil'?'active':''}">
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
      <button class="btn-add" onclick="openModalNew('modal-repostaje')">+ Repostaje</button>
    </div>
    ${renderRepostajes()}
  </div>

  <div class="veh-panel ${vehTab==='incidencias'?'active':''}">
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
      <button class="btn-add" style="background:var(--red)" onclick="openModalNew('modal-incidencia')">+ Incidencia</button>
    </div>
    ${renderIncidencias()}
  </div>

  <div class="veh-panel ${vehTab==='mantenimiento'?'active':''}">
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
      <button class="btn-add" style="background:var(--green)" onclick="openModalNew('modal-mantenimiento')">+ Mantenimiento</button>
    </div>
    ${renderMantenimientos()}
  </div>`;
}

function switchVehTab(t){vehTab=t;renderVehiculo();}

function renderRepostajes(){
  if(!DB.repostajes.length)return`<div class="empty"><div class="empty-icon">‚õΩ</div><div class="empty-text">Sin repostajes registrados</div></div>`;
  const sorted=[...DB.repostajes].sort((a,b)=>b.fecha.localeCompare(a.fecha));
  return sorted.map(r=>{
    const isOpen=openCards['rep'+r.id];
    const lkm=r.km?r.km.toLocaleString():'‚Äî';
    return`<div class="veh-item">
      <div class="veh-item-head" onclick="toggleCard('rep${r.id}')">
        <div class="veh-icon gasoil">‚õΩ</div>
        <div class="veh-item-info">
          <div class="veh-item-title">${fmtFecha(r.fecha)} ¬∑ ${r.vehiculo}</div>
          <div class="veh-item-sub">${r.litros}L ¬∑ ${r.precio.toFixed(3)}‚Ç¨/L ¬∑ <strong style="color:var(--warn)">${r.importe.toFixed(2)}‚Ç¨</strong></div>
        </div>
        <span class="badge badge-gold">${lkm}km</span>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="veh-item-expand ${isOpen?'open':''}">
        <div class="veh-detail-row"><span class="veh-detail-label">Veh√≠culo</span><span class="veh-detail-val">${r.vehiculo}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Kilometraje</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace">${lkm} km</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Litros</span><span class="veh-detail-val">${r.litros} L</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Precio/L</span><span class="veh-detail-val">${r.precio.toFixed(3)} ‚Ç¨</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Importe</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace;font-weight:700;color:var(--warn)">${r.importe.toFixed(2)} ‚Ç¨</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Gasolinera</span><span class="veh-detail-val">${r.gasolinera||'‚Äî'}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Conductor</span><span class="veh-detail-val">${r.conductor||'‚Äî'}</span></div>
        ${r.obs?`<div class="veh-detail-row"><span class="veh-detail-label">Notas</span><span class="veh-detail-val">${r.obs}</span></div>`:''}
        <div class="ruta-actions" style="margin-top:10px">
          <button class="btn-action primary" onclick="editRepostaje(${r.id})">‚úèÔ∏è Editar</button>
          <button class="btn-action danger" onclick="deleteRepostaje(${r.id})">üóëÔ∏è Eliminar</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderIncidencias(){
  if(!DB.incidencias.length)return`<div class="empty"><div class="empty-icon">‚úÖ</div><div class="empty-text">Sin incidencias registradas</div></div>`;
  const sorted=[...DB.incidencias].sort((a,b)=>b.fecha.localeCompare(a.fecha));
  return sorted.map(inc=>{
    const isOpen=openCards['inc'+inc.id];
    const sevClass={'Alta':'sev-alta','Media':'sev-media','Baja':'sev-baja'}[inc.gravedad]||'sev-baja';
    const estClass={'Pendiente':'estado-pendiente','En curso':'estado-en-curso','Resuelto':'estado-resuelto'}[inc.estado]||'estado-pendiente';
    return`<div class="veh-item" style="border-left:4px solid ${inc.gravedad==='Alta'?'var(--red)':inc.gravedad==='Media'?'var(--warn)':'var(--green)'}">
      <div class="veh-item-head" onclick="toggleCard('inc${inc.id}')">
        <div class="veh-icon incidencia">‚ö†Ô∏è</div>
        <div class="veh-item-info">
          <div class="veh-item-title">${inc.desc}</div>
          <div class="veh-item-sub">${fmtFecha(inc.fecha)} ¬∑ ${inc.vehiculo}</div>
          <div style="margin-top:4px;display:flex;gap:5px;flex-wrap:wrap">
            <span class="sev-pill ${sevClass}">${inc.gravedad==='Alta'?'üî¥':inc.gravedad==='Media'?'üü°':'üü¢'} ${inc.gravedad}</span>
            <span class="estado-pill ${estClass}">${inc.estado}</span>
          </div>
        </div>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="veh-item-expand ${isOpen?'open':''}">
        <div class="veh-detail-row"><span class="veh-detail-label">Veh√≠culo</span><span class="veh-detail-val">${inc.vehiculo}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Fecha</span><span class="veh-detail-val">${fmtFecha(inc.fecha)}</span></div>
        ${inc.km?`<div class="veh-detail-row"><span class="veh-detail-label">Km</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace">${inc.km.toLocaleString()} km</span></div>`:''}
        <div class="veh-detail-row"><span class="veh-detail-label">Conductor</span><span class="veh-detail-val">${inc.conductor||'‚Äî'}</span></div>
        ${inc.obs?`<div class="veh-detail-row"><span class="veh-detail-label">Notas</span><span class="veh-detail-val">${inc.obs}</span></div>`:''}
        <div class="ruta-actions" style="margin-top:10px">
          <button class="btn-action primary" onclick="editIncidencia(${inc.id})">‚úèÔ∏è Editar</button>
          <button class="btn-action danger" onclick="deleteIncidencia(${inc.id})">üóëÔ∏è Eliminar</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderMantenimientos(){
  if(!DB.mantenimientos.length)return`<div class="empty"><div class="empty-icon">üîß</div><div class="empty-text">Sin registros de mantenimiento</div></div>`;
  const sorted=[...DB.mantenimientos].sort((a,b)=>b.fecha.localeCompare(a.fecha));
  return sorted.map(m=>{
    const isOpen=openCards['mant'+m.id];
    const estClass={'Programado':'estado-programado','Completado':'estado-completado'}[m.estado]||'estado-programado';
    const vencido=m.kmProx&&m.kmActual&&m.kmActual>=m.kmProx;
    return`<div class="veh-item" style="border-left:4px solid ${m.estado==='Completado'?'var(--green)':vencido?'var(--red)':'var(--purple)'}">
      <div class="veh-item-head" onclick="toggleCard('mant${m.id}')">
        <div class="veh-icon mantenimiento">üîß</div>
        <div class="veh-item-info">
          <div class="veh-item-title">${m.tipo}</div>
          <div class="veh-item-sub">${fmtFecha(m.fecha)} ¬∑ ${m.vehiculo}</div>
          <div style="margin-top:4px;display:flex;gap:5px;flex-wrap:wrap">
            <span class="estado-pill ${estClass}">${m.estado}</span>
            ${m.coste?`<span class="badge badge-purple">üí∂ ${m.coste.toFixed(2)}‚Ç¨</span>`:''}
          </div>
        </div>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="veh-item-expand ${isOpen?'open':''}">
        <div class="veh-detail-row"><span class="veh-detail-label">Veh√≠culo</span><span class="veh-detail-val">${m.vehiculo}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Tipo</span><span class="veh-detail-val">${m.tipo}</span></div>
        ${m.desc?`<div class="veh-detail-row"><span class="veh-detail-label">Descripci√≥n</span><span class="veh-detail-val">${m.desc}</span></div>`:''}
        ${m.km?`<div class="veh-detail-row"><span class="veh-detail-label">Km actuales</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace">${m.km.toLocaleString()} km</span></div>`:''}
        ${m.kmProx?`<div class="veh-detail-row"><span class="veh-detail-label">Pr√≥ximo en</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace">${m.kmProx.toLocaleString()} km</span></div>`:''}
        ${m.coste?`<div class="veh-detail-row"><span class="veh-detail-label">Coste</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace;font-weight:700;color:var(--purple)">${m.coste.toFixed(2)} ‚Ç¨</span></div>`:''}
        <div class="veh-detail-row"><span class="veh-detail-label">Taller</span><span class="veh-detail-val">${m.taller||'‚Äî'}</span></div>
        <div class="ruta-actions" style="margin-top:10px">
          <button class="btn-action primary" onclick="editMantenimiento(${m.id})">‚úèÔ∏è Editar</button>
          <button class="btn-action danger" onclick="deleteMantenimiento(${m.id})">üóëÔ∏è Eliminar</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// CRUD Repostaje
function populateVehiculoSelects(){
  const opts=FLOTA.map(v=>`<option value="${v.id}">${v.nombre}</option>`).join('');
  ['rep-vehiculo','inc-vehiculo','mant-vehiculo'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.innerHTML=`<option value="">-- Selecciona --</option>${opts}`;
  });
}
function calcImporte(){const l=parseFloat(document.getElementById('rep-litros').value)||0;const p=parseFloat(document.getElementById('rep-precio').value)||0;if(l&&p)document.getElementById('rep-importe').value=(l*p).toFixed(2);}
function calcPrecio(){const l=parseFloat(document.getElementById('rep-litros').value)||0;const i=parseFloat(document.getElementById('rep-importe').value)||0;if(l&&i)document.getElementById('rep-precio').value=(i/l).toFixed(3);}
function editRepostaje(id){
  const r=DB.repostajes.find(x=>x.id===id);
  document.getElementById('modal-repostaje-title').textContent='‚úèÔ∏è Editar Repostaje';
  document.getElementById('rep-edit-id').value=id;
  document.getElementById('rep-fecha').value=r.fecha;
  document.getElementById('rep-vehiculo').value=r.vehiculo;
  document.getElementById('rep-km').value=r.km||'';
  document.getElementById('rep-litros').value=r.litros;
  document.getElementById('rep-precio').value=r.precio;
  document.getElementById('rep-importe').value=r.importe;
  document.getElementById('rep-gasolinera').value=r.gasolinera||'';
  document.getElementById('rep-obs').value=r.obs||'';
  openModal('modal-repostaje');
}
function deleteRepostaje(id){if(!confirm('¬øEliminar repostaje?'))return;DB.repostajes=DB.repostajes.filter(r=>r.id!==id);showToast('üóëÔ∏è Repostaje eliminado');renderVehiculo();}
function guardarRepostaje(){
  const litros=parseFloat(document.getElementById('rep-litros').value);
  const precio=parseFloat(document.getElementById('rep-precio').value);
  const importe=parseFloat(document.getElementById('rep-importe').value);
  if(!litros||(!precio&&!importe)){showToast('‚ö†Ô∏è Litros y precio/importe obligatorios');return;}
  const editId=parseInt(document.getElementById('rep-edit-id').value||0);
  const data={
    fecha:document.getElementById('rep-fecha').value||new Date().toISOString().split('T')[0],
    vehiculo:document.getElementById('rep-vehiculo').value,
    km:parseInt(document.getElementById('rep-km').value)||0,
    litros, precio:precio||(importe/litros),
    importe:importe||(litros*precio),
    gasolinera:document.getElementById('rep-gasolinera').value.trim(),
    obs:document.getElementById('rep-obs').value.trim(),
    conductor:currentUser?currentUser.user:'',
  };
  if(editId){const i=DB.repostajes.findIndex(r=>r.id===editId);DB.repostajes[i]={...DB.repostajes[i],...data};showToast('‚úÖ Repostaje actualizado');}
  else{data.id=DB.nextId.repostajes++;DB.repostajes.push(data);showToast('‚úÖ Repostaje guardado');}
  closeModal('modal-repostaje');renderVehiculo();
}

// CRUD Incidencia
function editIncidencia(id){
  const inc=DB.incidencias.find(x=>x.id===id);
  document.getElementById('modal-incidencia-title').textContent='‚úèÔ∏è Editar Incidencia';
  document.getElementById('inc-edit-id').value=id;
  document.getElementById('inc-fecha').value=inc.fecha;
  document.getElementById('inc-vehiculo').value=inc.vehiculo;
  document.getElementById('inc-desc').value=inc.desc;
  document.getElementById('inc-gravedad').value=inc.gravedad;
  document.getElementById('inc-estado').value=inc.estado;
  document.getElementById('inc-km').value=inc.km||'';
  document.getElementById('inc-obs').value=inc.obs||'';
  openModal('modal-incidencia');
}
function deleteIncidencia(id){if(!confirm('¬øEliminar incidencia?'))return;DB.incidencias=DB.incidencias.filter(i=>i.id!==id);showToast('üóëÔ∏è Incidencia eliminada');renderVehiculo();}
function guardarIncidencia(){
  const desc=document.getElementById('inc-desc').value.trim();
  if(!desc){showToast('‚ö†Ô∏è Descripci√≥n obligatoria');return;}
  const editId=parseInt(document.getElementById('inc-edit-id').value||0);
  const data={
    fecha:document.getElementById('inc-fecha').value||new Date().toISOString().split('T')[0],
    vehiculo:document.getElementById('inc-vehiculo').value,
    desc, gravedad:document.getElementById('inc-gravedad').value,
    estado:document.getElementById('inc-estado').value,
    km:parseInt(document.getElementById('inc-km').value)||0,
    obs:document.getElementById('inc-obs').value.trim(),
    conductor:currentUser?currentUser.user:'',
  };
  if(editId){const i=DB.incidencias.findIndex(x=>x.id===editId);DB.incidencias[i]={...DB.incidencias[i],...data};showToast('‚úÖ Incidencia actualizada');}
  else{data.id=DB.nextId.incidencias++;DB.incidencias.push(data);showToast('‚úÖ Incidencia registrada');}
  closeModal('modal-incidencia');renderVehiculo();
}

// CRUD Mantenimiento
function editMantenimiento(id){
  const m=DB.mantenimientos.find(x=>x.id===id);
  document.getElementById('modal-mant-title').textContent='‚úèÔ∏è Editar Mantenimiento';
  document.getElementById('mant-edit-id').value=id;
  document.getElementById('mant-fecha').value=m.fecha;
  document.getElementById('mant-vehiculo').value=m.vehiculo;
  document.getElementById('mant-tipo').value=m.tipo;
  document.getElementById('mant-desc').value=m.desc||'';
  document.getElementById('mant-km').value=m.km||'';
  document.getElementById('mant-km-prox').value=m.kmProx||'';
  document.getElementById('mant-coste').value=m.coste||'';
  document.getElementById('mant-estado').value=m.estado;
  document.getElementById('mant-taller').value=m.taller||'';
  openModal('modal-mantenimiento');
}
function deleteMantenimiento(id){if(!confirm('¬øEliminar mantenimiento?'))return;DB.mantenimientos=DB.mantenimientos.filter(m=>m.id!==id);showToast('üóëÔ∏è Mantenimiento eliminado');renderVehiculo();}
function guardarMantenimiento(){
  const tipo=document.getElementById('mant-tipo').value;
  const editId=parseInt(document.getElementById('mant-edit-id').value||0);
  const data={
    fecha:document.getElementById('mant-fecha').value||new Date().toISOString().split('T')[0],
    vehiculo:document.getElementById('mant-vehiculo').value,
    tipo, desc:document.getElementById('mant-desc').value.trim(),
    km:parseInt(document.getElementById('mant-km').value)||0,
    kmProx:parseInt(document.getElementById('mant-km-prox').value)||null,
    coste:parseFloat(document.getElementById('mant-coste').value)||0,
    estado:document.getElementById('mant-estado').value,
    taller:document.getElementById('mant-taller').value.trim(),
  };
  if(editId){const i=DB.mantenimientos.findIndex(m=>m.id===editId);DB.mantenimientos[i]={...DB.mantenimientos[i],...data};showToast('‚úÖ Mantenimiento actualizado');}
  else{data.id=DB.nextId.mantenimientos++;DB.mantenimientos.push(data);showToast('‚úÖ Mantenimiento registrado');}
  closeModal('modal-mantenimiento');renderVehiculo();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTI√ìN DE USUARIOS DEL SISTEMA (Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS array es mutable ‚Äî convertimos a let y extendemos con email/tel
let SYS_USERS = [
  {id:1, user:'admin',  pass:'lobu2024', role:'admin',  nombre:'Administrador', email:'admin@grouplobu.cat', tel:'972 000 000', activo:true},
  {id:2, user:'miquel', pass:'chofer1',  role:'chofer', nombre:'Miquel R.',      email:'miquel@grouplobu.cat', tel:'600 111 222', activo:true},
  {id:3, user:'jordi',  pass:'chofer2',  role:'chofer', nombre:'Jordi M.',       email:'jordi@grouplobu.cat',  tel:'600 333 444', activo:true},
  {id:4, user:'anna',   pass:'chofer3',  role:'chofer', nombre:'Anna P.',        email:'anna@grouplobu.cat',   tel:'600 555 666', activo:true},
];
let nextSysId=5;
let adminTab='revision'; // sub-tab within admin: revision | usuarios
let passVisible={};

function renderAdminPanel(){
  if(!currentUser||currentUser.role!=='admin'){
    document.getElementById('admin-content').innerHTML=`<div class="access-denied"><div style="font-size:64px;margin-bottom:16px">üîí</div><div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--red)">Acceso Restringido</div></div>`;
    return;
  }
  document.getElementById('admin-content').innerHTML=`
  <div class="sec-head"><div><div class="sec-title">Admin</div><div class="sec-sub">Panel de administraci√≥n</div></div></div>
  <div class="admin-badge">üëë ${currentUser.nombre}</div>

  <div class="admin-panel-tabs">
    <div class="admin-panel-tab ${adminTab==='usuarios'?'active':''}" onclick="setAdminTab('usuarios')">üë§ Usuarios del sistema</div>
    <div class="admin-panel-tab ${adminTab==='config'?'active':''}" onclick="setAdminTab('config')">‚öôÔ∏è Configuraci√≥n</div>
  </div>

  <div class="admin-panel-section ${adminTab==='usuarios'?'active':''}">
    ${renderSysUsers()}
  </div>
  <div class="admin-panel-section ${adminTab==='config'?'active':''}">
    ${renderConfig()}
  </div>`;
}

function setAdminTab(t){adminTab=t;renderAdminPanel();}

function renderSysUsers(){
  const activos=SYS_USERS.filter(u=>u.activo).length;
  return`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div>
      <div style="font-weight:700;font-size:15px">Usuarios del sistema</div>
      <div style="font-size:12px;color:var(--muted)">${SYS_USERS.length} usuarios ¬∑ ${activos} activos</div>
    </div>
    <button class="btn-add" onclick="openModalNew('modal-sys-user')">+ Nuevo</button>
  </div>
  ${SYS_USERS.map(u=>{
    const isOpen=openCards['su'+u.id];
    const roleBadge=u.role==='admin'?`<span class="role-badge-admin">üëë Admin</span>`:`<span class="role-badge-chofer">üöê Chofer</span>`;
    const avatarColor=u.role==='admin'?'var(--purple)':'var(--blue)';
    const avatarBg=u.role==='admin'?'var(--purple-bg)':'var(--blue-bg)';
    const passShow=passVisible[u.id];
    return`<div class="sys-user-card" style="opacity:${u.activo?1:.5}">
      <div class="sys-user-head" onclick="toggleCard('su${u.id}')">
        <div class="sys-user-avatar" style="background:${avatarBg};color:${avatarColor};border:2px solid ${avatarColor}44">${u.nombre[0]}</div>
        <div class="sys-user-info">
          <div class="sys-user-name">${u.nombre} ${!u.activo?'<span style="font-size:11px;color:var(--red)">(Inactivo)</span>':''}</div>
          <div class="sys-user-meta">@${u.user} ¬∑ ${u.tel||'‚Äî'}</div>
          <div style="margin-top:4px;display:flex;gap:5px">${roleBadge}</div>
        </div>
        <span class="chevron ${isOpen?'open':''}">‚ñæ</span>
      </div>
      <div class="sys-user-expand ${isOpen?'open':''}">
        <div class="veh-detail-row"><span class="veh-detail-label">Nombre</span><span class="veh-detail-val">${u.nombre}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Usuario</span><span class="veh-detail-val" style="font-family:'DM Mono',monospace">@${u.user}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Email</span><span class="veh-detail-val">${u.email||'‚Äî'}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Tel√©fono</span><span class="veh-detail-val">${u.tel||'‚Äî'}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Rol</span><span class="veh-detail-val">${u.role==='admin'?'üëë Administrador':'üöê Chofer'}</span></div>
        <div class="veh-detail-row"><span class="veh-detail-label">Contrase√±a</span><span class="veh-detail-val">
          <div class="pass-field"><span id="pass-txt-${u.id}">${passShow?u.pass:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span><button class="pass-toggle" onclick="togglePass(${u.id})">${passShow?'üôà Ocultar':'üëÅ Ver'}</button></div>
        </span></div>
        <div class="ruta-actions" style="margin-top:10px">
          <button class="btn-action primary" onclick="editSysUser(${u.id})">‚úèÔ∏è Editar</button>
          ${u.user!=='admin'?`<button class="btn-action" onclick="toggleSysUserActivo(${u.id})">${u.activo?'üîí Desactivar':'‚úÖ Activar'}</button>`:''}
          ${u.user!=='admin'?`<button class="btn-action danger" onclick="deleteSysUser(${u.id})">üóëÔ∏è Eliminar</button>`:''}
        </div>
      </div>
    </div>`;
  }).join('')}`;
}

function renderConfig(){
  return`
  <div class="card" style="margin-bottom:10px">
    <div style="font-weight:700;font-size:15px;margin-bottom:10px">üè¢ Centros activos</div>
    ${['Mar i Sol','Can Clement (CD)','Calella CD','Mixto'].map(c=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${c}</span>
      <span class="badge badge-green">‚úì Activo</span>
    </div>`).join('')}
  </div>
  <div class="card" style="margin-bottom:10px">
    <div style="font-weight:700;font-size:15px;margin-bottom:10px">üöê Flota registrada</div>
    ${FLOTA.map(v=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <div><div style="font-size:14px;font-weight:600">${v.nombre}</div><div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${v.id}</div></div>
      <span class="badge badge-blue">Activo</span>
    </div>`).join('')}
  </div>
  <div class="card">
    <div style="font-weight:700;font-size:15px;margin-bottom:4px">‚ÑπÔ∏è Versi√≥n del sistema</div>
    <div style="font-size:12px;color:var(--muted)">Group Lobu Transport v2.1 ¬∑ Group Lobu ¬∑ Estima i Vida</div>
  </div>`;
}

function togglePass(id){passVisible[id]=!passVisible[id];renderAdminPanel();}

function editSysUser(id){
  const u=SYS_USERS.find(x=>x.id===id);
  document.getElementById('modal-sys-user-title').textContent='‚úèÔ∏è Editar Usuario';
  document.getElementById('sys-user-edit-id').value=id;
  document.getElementById('sys-nombre').value=u.nombre;
  document.getElementById('sys-role').value=u.role;
  document.getElementById('sys-user').value=u.user;
  document.getElementById('sys-pass').value=u.pass;
  document.getElementById('sys-email').value=u.email||'';
  document.getElementById('sys-tel').value=u.tel||'';
  openModal('modal-sys-user');
}

function toggleSysUserActivo(id){
  const u=SYS_USERS.find(x=>x.id===id);
  u.activo=!u.activo;
  showToast(`${u.activo?'‚úÖ Activado':'üîí Desactivado'}: ${u.nombre}`);
  renderAdminPanel();
}

function deleteSysUser(id){
  const u=SYS_USERS.find(x=>x.id===id);
  if(!confirm(`¬øEliminar usuario ${u.nombre}? Esta acci√≥n no se puede deshacer.`))return;
  SYS_USERS=SYS_USERS.filter(x=>x.id!==id);
  showToast('üóëÔ∏è Usuario eliminado');
  renderAdminPanel();
}

function guardarSysUser(){
  const nombre=document.getElementById('sys-nombre').value.trim();
  const user=document.getElementById('sys-user').value.trim().toLowerCase();
  const pass=document.getElementById('sys-pass').value;
  if(!nombre||!user||!pass){showToast('‚ö†Ô∏è Nombre, usuario y contrase√±a obligatorios');return;}
  const editId=parseInt(document.getElementById('sys-user-edit-id').value||0);
  // Check duplicate username
  const dup=SYS_USERS.find(u=>u.user===user&&u.id!==editId);
  if(dup){showToast('‚ö†Ô∏è Ese nombre de usuario ya existe');return;}
  const data={nombre,user,pass,role:document.getElementById('sys-role').value,email:document.getElementById('sys-email').value.trim(),tel:document.getElementById('sys-tel').value.trim()};
  if(editId){
    const i=SYS_USERS.findIndex(u=>u.id===editId);
    SYS_USERS[i]={...SYS_USERS[i],...data};
    // Update currentUser if editing self
    if(currentUser&&currentUser.user===SYS_USERS[i].user){currentUser={...currentUser,...data};document.getElementById('header-user').innerHTML=`üëë ${data.nombre}`;}
    showToast('‚úÖ Usuario actualizado');
  } else {
    SYS_USERS.push({id:nextSysId++,activo:true,...data});
    showToast('‚úÖ Usuario creado');
  }
  closeModal('modal-sys-user');
  renderAdminPanel();
}

// Make USERS (used in login) reference SYS_USERS dynamically
// Override doLogin to use SYS_USERS
const _origLogin = doLogin;
window.doLogin = function(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value;
  const found=SYS_USERS.find(x=>x.user===u&&x.pass===p&&x.activo!==false);
  if(!found){document.getElementById('login-error').classList.add('show');document.getElementById('login-pass').value='';return;}
  currentUser=found;
  document.getElementById('login-error').classList.remove('show');
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('main-nav').style.display='flex';
  document.getElementById('header-user').innerHTML=`${found.role==='admin'?'üëë':'üë§'} ${found.nombre}`;
  const isAdmin=found.role==='admin';
  ['nav-revision','nav-informes','nav-admin'].forEach(id=>{
    document.getElementById(id).style.display=isAdmin?'flex':'none';
  });
  init();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INFORMES (Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let infTab='gasoil';
let infDesde='';let infHasta='';let infVeh='';

function renderInformes(){
  if(!currentUser||currentUser.role!=='admin'){
    document.getElementById('informes-content').innerHTML=`<div class="access-denied"><div style="font-size:64px;margin-bottom:16px">üîí</div><div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--red)">Acceso Restringido</div></div>`;
    return;
  }
  const vehOpts=FLOTA.map(v=>`<option value="${v.id}">${v.nombre}</option>`).join('');
  document.getElementById('informes-content').innerHTML=`
  <div class="sec-head"><div><div class="sec-title">Informes</div><div class="sec-sub">Resultados y exportaci√≥n</div></div></div>
  <div class="admin-badge">üëë ${currentUser.nombre} ¬∑ Administrador</div>

  <div class="inf-tabs">
    <div class="inf-tab ${infTab==='gasoil'?'active':''}" onclick="setInfTab('gasoil')">‚õΩ Gasoil</div>
    <div class="inf-tab ${infTab==='rutas'?'active':''}" onclick="setInfTab('rutas')">üó∫Ô∏è Rutas</div>
    <div class="inf-tab ${infTab==='incidencias'?'active':''}" onclick="setInfTab('incidencias')">‚ö†Ô∏è Incidencias</div>
    <div class="inf-tab ${infTab==='mantenimiento'?'active':''}" onclick="setInfTab('mantenimiento')">üîß Mant.</div>
  </div>

  <!-- FILTROS -->
  <div class="card" style="margin-bottom:12px;padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Filtros</div>
    <div class="inf-filter-row">
      <span class="inf-filter-label">Desde</span>
      <input class="inf-date-input" type="date" id="inf-desde" value="${infDesde}" onchange="infDesde=this.value;renderInformes()">
    </div>
    <div class="inf-filter-row">
      <span class="inf-filter-label">Hasta</span>
      <input class="inf-date-input" type="date" id="inf-hasta" value="${infHasta}" onchange="infHasta=this.value;renderInformes()">
    </div>
    <div class="inf-filter-row">
      <span class="inf-filter-label">Veh√≠culo</span>
      <select class="inf-date-input" onchange="infVeh=this.value;renderInformes()" style="background:var(--surface)">
        <option value="">Todos</option>${vehOpts}
      </select>
    </div>
    <button style="margin-top:8px;padding:7px 14px;background:none;border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer" onclick="infDesde='';infHasta='';infVeh='';renderInformes()">‚úï Limpiar filtros</button>
  </div>

  <div id="inf-resultado"></div>`;

  // Render result based on active tab
  renderInfResultado();
}

function setInfTab(t){infTab=t;renderInformes();}

function applyFilters(arr, fechaKey){
  return arr.filter(r=>{
    if(infDesde&&r[fechaKey]<infDesde)return false;
    if(infHasta&&r[fechaKey]>infHasta)return false;
    if(infVeh&&r.vehiculo&&r.vehiculo!==infVeh)return false;
    return true;
  });
}

function renderInfResultado(){
  const el=document.getElementById('inf-resultado');
  if(!el)return;
  if(infTab==='gasoil') el.innerHTML=infGasoil();
  else if(infTab==='rutas') el.innerHTML=infRutas();
  else if(infTab==='incidencias') el.innerHTML=infIncidencias();
  else if(infTab==='mantenimiento') el.innerHTML=infMantenimiento();
}

function infGasoil(){
  const data=applyFilters(DB.repostajes,'fecha');
  const totalLitros=data.reduce((s,r)=>s+r.litros,0);
  const totalEuros=data.reduce((s,r)=>s+r.importe,0);
  const precioMedio=data.length?totalEuros/totalLitros:0;

  // Por veh√≠culo
  const porVeh={};data.forEach(r=>{if(!porVeh[r.vehiculo])porVeh[r.vehiculo]={litros:0,euros:0,repostajes:0};porVeh[r.vehiculo].litros+=r.litros;porVeh[r.vehiculo].euros+=r.importe;porVeh[r.vehiculo].repostajes++;});
  const maxEuros=Math.max(...Object.values(porVeh).map(v=>v.euros),1);

  return`
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--warn)">${data.length}</div><div class="veh-kpi-l">Repostajes</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--blue)">${totalLitros.toFixed(0)}L</div><div class="veh-kpi-l">Litros total</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--red);font-size:16px">${totalEuros.toFixed(2)}‚Ç¨</div><div class="veh-kpi-l">Gasto total</div></div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <div style="font-weight:700;font-size:14px;margin-bottom:10px">üìä Gasto por veh√≠culo</div>
    ${Object.entries(porVeh).map(([v,d])=>`
    <div class="chart-bar-wrap">
      <div class="chart-bar-label"><span style="font-weight:600">${v}</span><span style="color:var(--warn);font-weight:700">${d.euros.toFixed(2)}‚Ç¨</span></div>
      <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${(d.euros/maxEuros*100).toFixed(0)}%;background:linear-gradient(90deg,var(--warn),#C89A40)"></div></div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;margin-bottom:8px">${d.litros.toFixed(1)}L ¬∑ ${d.repostajes} repostajes ¬∑ ${(d.euros/d.litros).toFixed(3)}‚Ç¨/L medio</div>
    </div>`).join('')}
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:13px;font-weight:700">
      <span>Precio medio/litro</span><span style="font-family:'DM Mono',monospace;color:var(--gold)">${precioMedio.toFixed(3)} ‚Ç¨/L</span>
    </div>
  </div>
  ${data.length?`<div class="card" style="overflow-x:auto"><table class="inf-table">
    <thead><tr><th>Fecha</th><th>Veh√≠culo</th><th>Litros</th><th>‚Ç¨/L</th><th>Importe</th><th>Conductor</th></tr></thead>
    <tbody>
    ${data.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(r=>`<tr><td>${fmtFechaCorta(r.fecha)}</td><td style="font-size:11px">${r.vehiculo}</td><td style="font-family:'DM Mono',monospace">${r.litros}L</td><td style="font-family:'DM Mono',monospace">${r.precio.toFixed(3)}</td><td style="font-weight:700;color:var(--warn)">${r.importe.toFixed(2)}‚Ç¨</td><td style="font-size:11px">${r.conductor||'‚Äî'}</td></tr>`).join('')}
    <tr class="inf-total-row"><td colspan="2">TOTAL</td><td>${totalLitros.toFixed(1)}L</td><td>${precioMedio.toFixed(3)}</td><td>${totalEuros.toFixed(2)}‚Ç¨</td><td></td></tr>
    </tbody>
  </table></div>
  <button class="inf-export-btn" onclick="exportCSV('gasoil')">üì• Exportar CSV</button>`:`<div class="empty"><div class="empty-icon">‚õΩ</div><div class="empty-text">Sin datos para el per√≠odo seleccionado</div></div>`}`;
}

function infRutas(){
  const hdata=applyFilters(DB.historial,'fecha');
  const totalTrayectos=hdata.length;
  const conductores={};hdata.forEach(h=>{if(h.conductor){if(!conductores[h.conductor])conductores[h.conductor]=0;conductores[h.conductor]++;}});
  const maxTray=Math.max(...Object.values(conductores),1);
  const durations=[];hdata.forEach(h=>{if(h.eventos.length>=2){const ts=h.eventos.map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));if(ts.length>=2)durations.push(Math.max(...ts)-Math.min(...ts));}});
  const durMedia=durations.length?Math.round(durations.reduce((s,d)=>s+d,0)/durations.length):null;

  return`
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--blue)">${totalTrayectos}</div><div class="veh-kpi-l">Trayectos reg.</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--green)">${durMedia!==null?durMedia+'min':'‚Äî'}</div><div class="veh-kpi-l">Duraci√≥n media</div></div>
  </div>
  ${Object.keys(conductores).length?`<div class="card" style="margin-bottom:12px">
    <div style="font-weight:700;font-size:14px;margin-bottom:10px">üë§ Trayectos por conductor</div>
    ${Object.entries(conductores).sort((a,b)=>b[1]-a[1]).map(([c,n])=>`
    <div class="chart-bar-wrap">
      <div class="chart-bar-label"><span style="font-weight:600">@${c}</span><span style="font-weight:700;color:var(--blue)">${n} trayectos</span></div>
      <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${(n/maxTray*100).toFixed(0)}%;background:linear-gradient(90deg,var(--blue),#5A9ABE)"></div></div>
    </div>`).join('')}
  </div>`:''}
  ${hdata.length?`<div class="card" style="overflow-x:auto"><table class="inf-table">
    <thead><tr><th>Fecha</th><th>Ruta</th><th>Turno</th><th>Conductor</th><th>Eventos</th><th>Duraci√≥n</th></tr></thead>
    <tbody>${hdata.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(h=>{const r=DB.rutas.find(x=>x.id===h.rutaId);const ts=h.eventos.map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));const dur=ts.length>=2?Math.max(...ts)-Math.min(...ts):null;return`<tr><td>${fmtFechaCorta(h.fecha)}</td><td style="font-size:11px">${r?r.nombre:'‚Äî'}</td><td><span class="badge ${h.turno==='Tarde'?'badge-warn':'badge-blue'}">${h.turno}</span></td><td style="font-size:11px">@${h.conductor||'‚Äî'}</td><td style="text-align:center">${h.eventos.length}</td><td style="font-family:'DM Mono',monospace">${dur!==null?dur+'min':'‚Äî'}</td></tr>`;}).join('')}</tbody>
  </table></div>
  <button class="inf-export-btn" onclick="exportCSV('rutas')">üì• Exportar CSV</button>`:`<div class="empty"><div class="empty-icon">üó∫Ô∏è</div><div class="empty-text">Sin historial para el per√≠odo</div></div>`}`;
}

function infIncidencias(){
  const data=applyFilters(DB.incidencias,'fecha');
  const abiertas=data.filter(i=>i.estado!=='Resuelto').length;
  const altas=data.filter(i=>i.gravedad==='Alta').length;
  const porVeh={};data.forEach(i=>{if(!porVeh[i.vehiculo])porVeh[i.vehiculo]=0;porVeh[i.vehiculo]++;});
  const maxInc=Math.max(...Object.values(porVeh),1);

  return`
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--text)">${data.length}</div><div class="veh-kpi-l">Total</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--warn)">${abiertas}</div><div class="veh-kpi-l">Abiertas</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--red)">${altas}</div><div class="veh-kpi-l">Alta gravedad</div></div>
  </div>
  ${Object.keys(porVeh).length>1?`<div class="card" style="margin-bottom:12px">
    <div style="font-weight:700;font-size:14px;margin-bottom:10px">üöê Incidencias por veh√≠culo</div>
    ${Object.entries(porVeh).sort((a,b)=>b[1]-a[1]).map(([v,n])=>`
    <div class="chart-bar-wrap">
      <div class="chart-bar-label"><span style="font-weight:600">${v}</span><span style="font-weight:700;color:var(--red)">${n} incidencias</span></div>
      <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${(n/maxInc*100).toFixed(0)}%;background:linear-gradient(90deg,var(--red),#C06060)"></div></div>
    </div>`).join('')}
  </div>`:''}
  ${data.length?`<div class="card" style="overflow-x:auto"><table class="inf-table">
    <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Veh√≠culo</th><th>Gravedad</th><th>Estado</th></tr></thead>
    <tbody>${data.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(i=>`<tr><td>${fmtFechaCorta(i.fecha)}</td><td style="font-size:12px">${i.desc}</td><td style="font-size:11px">${i.vehiculo}</td><td><span class="sev-pill sev-${i.gravedad.toLowerCase()}">${i.gravedad}</span></td><td><span class="estado-pill estado-${i.estado.toLowerCase().replace(' ','-')}">${i.estado}</span></td></tr>`).join('')}</tbody>
  </table></div>
  <button class="inf-export-btn" onclick="exportCSV('incidencias')">üì• Exportar CSV</button>`:`<div class="empty"><div class="empty-icon">‚úÖ</div><div class="empty-text">Sin incidencias para el per√≠odo</div></div>`}`;
}

function infMantenimiento(){
  const data=applyFilters(DB.mantenimientos,'fecha');
  const totalCoste=data.reduce((s,m)=>s+(m.coste||0),0);
  const prog=data.filter(m=>m.estado==='Programado').length;

  return`
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--text)">${data.length}</div><div class="veh-kpi-l">Intervenciones</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--purple)">${prog}</div><div class="veh-kpi-l">Programados</div></div>
    <div class="veh-kpi"><div class="veh-kpi-n" style="color:var(--green);font-size:16px">${totalCoste.toFixed(0)}‚Ç¨</div><div class="veh-kpi-l">Coste total</div></div>
  </div>
  ${data.length?`<div class="card" style="overflow-x:auto"><table class="inf-table">
    <thead><tr><th>Fecha</th><th>Veh√≠culo</th><th>Tipo</th><th>Km</th><th>Coste</th><th>Estado</th></tr></thead>
    <tbody>${data.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(m=>`<tr><td>${fmtFechaCorta(m.fecha)}</td><td style="font-size:11px">${m.vehiculo}</td><td style="font-size:12px">${m.tipo}</td><td style="font-family:'DM Mono',monospace;font-size:11px">${m.km?m.km.toLocaleString()+'km':'‚Äî'}</td><td style="font-weight:700;color:var(--purple)">${m.coste?m.coste.toFixed(2)+'‚Ç¨':'‚Äî'}</td><td><span class="estado-pill ${m.estado==='Completado'?'estado-completado':'estado-programado'}">${m.estado}</span></td></tr>`).join('')}
    <tr class="inf-total-row"><td colspan="4">TOTAL COSTE</td><td>${totalCoste.toFixed(2)}‚Ç¨</td><td></td></tr>
    </tbody>
  </table></div>
  <button class="inf-export-btn" onclick="exportCSV('mantenimiento')">üì• Exportar CSV</button>`:`<div class="empty"><div class="empty-icon">üîß</div><div class="empty-text">Sin mantenimientos para el per√≠odo</div></div>`}`;
}

function fmtFechaCorta(f){if(!f)return'‚Äî';const[y,m,d]=f.split('-');return`${d}/${m}/${y.slice(2)}`;}

function exportCSV(tipo){
  let rows=[];let filename='';
  const sep=';';
  if(tipo==='gasoil'){
    filename='repostajes.csv';
    rows=[['Fecha','Veh√≠culo','Km','Litros','‚Ç¨/Litro','Importe','Gasolinera','Conductor']];
    applyFilters(DB.repostajes,'fecha').forEach(r=>rows.push([r.fecha,r.vehiculo,r.km,r.litros,r.precio.toFixed(3),r.importe.toFixed(2),r.gasolinera||'',r.conductor||'']));
  } else if(tipo==='rutas'){
    filename='historial_rutas.csv';
    rows=[['Fecha','Ruta','Turno','Conductor','Num Eventos','Duraci√≥n (min)']];
    applyFilters(DB.historial,'fecha').forEach(h=>{const r=DB.rutas.find(x=>x.id===h.rutaId);const ts=h.eventos.map(e=>timeToMin(e.hora)).filter(x=>!isNaN(x));const dur=ts.length>=2?Math.max(...ts)-Math.min(...ts):'';rows.push([h.fecha,r?r.nombre:'‚Äî',h.turno,h.conductor||'',h.eventos.length,dur]);});
  } else if(tipo==='incidencias'){
    filename='incidencias.csv';
    rows=[['Fecha','Veh√≠culo','Descripci√≥n','Gravedad','Estado','Km','Conductor']];
    applyFilters(DB.incidencias,'fecha').forEach(i=>rows.push([i.fecha,i.vehiculo,i.desc,i.gravedad,i.estado,i.km||'',i.conductor||'']));
  } else if(tipo==='mantenimiento'){
    filename='mantenimiento.csv';
    rows=[['Fecha','Veh√≠culo','Tipo','Descripci√≥n','Km','Km pr√≥ximo','Coste ‚Ç¨','Estado','Taller']];
    applyFilters(DB.mantenimientos,'fecha').forEach(m=>rows.push([m.fecha,m.vehiculo,m.tipo,m.desc||'',m.km||'',m.kmProx||'',(m.coste||0).toFixed(2),m.estado,m.taller||'']));
  }
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(sep)).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
  showToast(`üì• ${filename} descargado`);
}

// Update closeModal for sys-user modal
const _origCloseModal=closeModal;
window.closeModal=function(id){
  _origCloseModal(id);
  if(id==='modal-sys-user')document.getElementById('sys-user-edit-id').value='';
};

// Update openModalNew for sys-user
const _origOpenModalNew=openModalNew;
window.openModalNew=function(id){
  if(id==='modal-sys-user'){
    document.getElementById('modal-sys-user-title').textContent='üë§ Nuevo Usuario';
    document.getElementById('sys-user-edit-id').value='';
    ['sys-nombre','sys-user','sys-pass','sys-email','sys-tel'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('sys-role').value='chofer';
    document.getElementById('modal-sys-user').classList.add('open');
    return;
  }
  _origOpenModalNew(id);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-SYNC FIREBASE ‚Äî Interceptar todas las funciones
// que modifican datos para guardar autom√°ticamente
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function withSync(fn) {
  return function(...args) {
    const result = fn.apply(this, args);
    if (typeof window.firebasePushDB === 'function') window.firebasePushDB();
    return result;
  };
}

// Rutas
const _guardarRuta=guardarRuta; window.guardarRuta=withSync(_guardarRuta);
const _deleteRuta=deleteRuta;   window.deleteRuta=withSync(_deleteRuta);

// Grupos
const _guardarGrupo=guardarGrupo; window.guardarGrupo=withSync(_guardarGrupo);
const _deleteGrupo=deleteGrupo;   window.deleteGrupo=withSync(_deleteGrupo);

// Usuarios (pasajeros)
const _guardarUsuario=guardarUsuario; window.guardarUsuario=withSync(_guardarUsuario);
const _deleteUsuario=deleteUsuario;   window.deleteUsuario=withSync(_deleteUsuario);

// Marcajes
const _marcarGrupo=marcarGrupo;
window.marcarGrupo=function(rutaId,tipo){_marcarGrupo(rutaId,tipo);if(typeof window.firebasePushDB==='function')window.firebasePushDB();};
const _marcarUsuarioRecogida=marcarUsuarioRecogida;
window.marcarUsuarioRecogida=function(rutaId,uid){_marcarUsuarioRecogida(rutaId,uid);if(typeof window.firebasePushDB==='function')window.firebasePushDB();};
const _marcarUsuarioDomicilio=marcarUsuarioDomicilio;
window.marcarUsuarioDomicilio=function(rutaId,uid){_marcarUsuarioDomicilio(rutaId,uid);if(typeof window.firebasePushDB==='function')window.firebasePushDB();};

// Veh√≠culo
const _guardarRepostaje=guardarRepostaje;   window.guardarRepostaje=withSync(_guardarRepostaje);
const _deleteRepostaje=deleteRepostaje;     window.deleteRepostaje=withSync(_deleteRepostaje);
const _guardarIncidencia=guardarIncidencia; window.guardarIncidencia=withSync(_guardarIncidencia);
const _deleteIncidencia=deleteIncidencia;   window.deleteIncidencia=withSync(_deleteIncidencia);
const _guardarMantenimiento=guardarMantenimiento; window.guardarMantenimiento=withSync(_guardarMantenimiento);
const _deleteMantenimiento=deleteMantenimiento;   window.deleteMantenimiento=withSync(_deleteMantenimiento);

// Usuarios del sistema (admin)
const _guardarSysUser=guardarSysUser;           window.guardarSysUser=withSync(_guardarSysUser);
const _deleteSysUser=deleteSysUser;             window.deleteSysUser=withSync(_deleteSysUser);
const _toggleSysUserActivo=toggleSysUserActivo; window.toggleSysUserActivo=withSync(_toggleSysUserActivo);

// Exponer DB y SYS_USERS globalmente para el m√≥dulo Firebase
window.DB = DB;
window.SYS_USERS = SYS_USERS;
window.nextSysId = nextSysId;
</script>
</body>
</html>
